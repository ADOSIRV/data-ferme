<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord Avicole v7</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root{--bg-primary:#0a0f1a;--bg-secondary:#111827;--bg-card:#1a2236;--accent-green:#10b981;--accent-green-light:rgba(16,185,129,0.15);--accent-amber:#f59e0b;--accent-amber-light:rgba(245,158,11,0.15);--accent-blue:#3b82f6;--accent-blue-light:rgba(59,130,246,0.15);--accent-red:#ef4444;--accent-red-light:rgba(239,68,68,0.15);--accent-purple:#8b5cf6;--accent-purple-light:rgba(139,92,246,0.15);--text-primary:#f1f5f9;--text-secondary:#94a3b8;--text-muted:#64748b;--border:#2d3a52}
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'DM Sans',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh}
        .page{display:none;min-height:100vh}.page.active{display:flex;align-items:center;justify-content:center}.page-app.active{display:block}
        .login-container{width:100%;max-width:420px;padding:1.5rem}
        .login-logo{text-align:center;margin-bottom:1.5rem}
        .login-logo-icon{width:70px;height:70px;background:linear-gradient(135deg,var(--accent-green),var(--accent-blue));border-radius:16px;display:inline-flex;align-items:center;justify-content:center;font-size:2rem;margin-bottom:0.75rem}
        .login-logo h1{font-size:1.3rem;margin-bottom:0.25rem}.login-logo p{color:var(--text-muted);font-size:0.85rem}
        .card{background:var(--bg-card);border-radius:16px;padding:1.5rem;border:1px solid var(--border)}
        .form-group{margin-bottom:1rem}.form-label{display:block;font-size:0.75rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;margin-bottom:0.4rem}
        .form-input{width:100%;padding:0.75rem;background:var(--bg-secondary);border:2px solid var(--border);border-radius:8px;color:var(--text-primary);font-family:inherit;font-size:0.95rem}
        .form-input:focus{outline:none;border-color:var(--accent-blue)}
        .btn{width:100%;padding:0.85rem;border:none;border-radius:8px;font-family:inherit;font-size:0.95rem;font-weight:600;cursor:pointer}
        .btn-primary{background:linear-gradient(135deg,var(--accent-green),var(--accent-blue));color:white}
        .btn-secondary{background:var(--bg-secondary);border:2px solid var(--border);color:var(--text-secondary)}
        .alert{padding:0.65rem;border-radius:6px;margin-bottom:0.75rem;display:none;font-size:0.8rem}.alert.show{display:block}
        .alert-error{background:var(--accent-red-light);border:1px solid var(--accent-red);color:var(--accent-red)}
        .alert-success{background:var(--accent-green-light);border:1px solid var(--accent-green);color:var(--accent-green)}
        .alert-info{background:var(--accent-blue-light);border:1px solid var(--accent-blue);color:var(--accent-blue)}
        .status-box{text-align:center;margin-top:1rem;padding:0.6rem;background:var(--bg-secondary);border-radius:6px;font-size:0.8rem}
        .status-box.ok{background:var(--accent-green-light);color:var(--accent-green)}.status-box.warning{background:var(--accent-amber-light);color:var(--accent-amber)}
        .config-container{width:100%;max-width:500px;padding:1.5rem}
        .config-section{margin-bottom:1.5rem;padding-bottom:1.5rem;border-bottom:1px solid var(--border)}.config-section:last-child{border-bottom:none}
        .config-title{font-weight:600;margin-bottom:0.75rem;color:var(--accent-blue);font-size:0.9rem}
        .btn-group{display:flex;gap:0.75rem;margin-top:0.75rem}.btn-group .btn{flex:1}
        .back-link{display:block;text-align:center;margin-top:1rem;color:var(--accent-blue);cursor:pointer;font-size:0.85rem}
        .session-bar{position:fixed;top:0.75rem;right:0.75rem;background:var(--bg-card);border:1px solid var(--border);border-radius:30px;padding:0.4rem 0.75rem;display:none;align-items:center;gap:0.5rem;font-size:0.75rem;z-index:1000}
        .session-user{color:var(--text-primary);font-weight:500}
        .session-role{padding:0.15rem 0.4rem;border-radius:4px;font-size:0.65rem;font-weight:600}
        .session-role.config{background:var(--accent-red-light);color:var(--accent-red)}
        .session-role.admin{background:var(--accent-amber-light);color:var(--accent-amber)}
        .session-role.eleveur{background:var(--accent-green-light);color:var(--accent-green)}
        .session-btn{background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;padding:0.25rem 0.5rem;color:var(--text-muted);font-size:0.7rem;cursor:pointer}
        .container{max-width:1400px;margin:0 auto;padding:1.5rem}
        .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}
        .header-left{display:flex;align-items:center;gap:0.75rem}
        .logo{width:40px;height:40px;background:linear-gradient(135deg,var(--accent-green),var(--accent-blue));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem}
        .header h1{font-size:1.25rem}.header-subtitle{color:var(--text-muted);font-size:0.8rem}
        .last-update{font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:var(--text-muted);background:var(--bg-secondary);padding:0.4rem 0.75rem;border-radius:6px}
        .farmer-card{background:var(--bg-card);border-radius:12px;padding:1rem;border:1px solid var(--border);display:flex;align-items:center;gap:1rem;flex-wrap:wrap;margin-bottom:1rem}
        .farmer-icon{width:44px;height:44px;background:var(--accent-green-light);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.3rem}
        .farmer-info{flex:1;min-width:150px}.farmer-label{font-size:0.65rem;text-transform:uppercase;color:var(--text-muted);font-weight:600}
        .farmer-name{font-size:1rem;font-weight:600}.farmer-company{font-size:0.85rem;color:var(--accent-green)}
        .farmer-details{display:flex;gap:1.5rem;flex-wrap:wrap}.farmer-detail{display:flex;flex-direction:column}
        .detail-label{font-size:0.65rem;text-transform:uppercase;color:var(--text-muted)}.detail-value{font-family:'JetBrains Mono',monospace;font-size:0.8rem}
        .selectors-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1rem;margin-bottom:1rem}
        .selectors-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:0.75rem}
        .selector-group label{display:block;font-size:0.65rem;text-transform:uppercase;color:var(--text-muted);margin-bottom:0.3rem;font-weight:600}
        .selector-select{width:100%;padding:0.6rem 2rem 0.6rem 0.75rem;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-family:inherit;font-size:0.85rem;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%2394a3b8' d='M5 7L0 2h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 0.75rem center}
        .selector-select:disabled{opacity:0.5}
        .lot-info-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1rem;margin-bottom:1rem}
        .lot-info-title{font-size:0.85rem;font-weight:600;margin-bottom:0.75rem}
        .lot-info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:0.6rem}
        .lot-info-item{background:var(--bg-secondary);padding:0.6rem;border-radius:6px}
        .lot-info-label{font-size:0.6rem;color:var(--text-muted);text-transform:uppercase}
        .lot-info-value{font-family:'JetBrains Mono',monospace;font-size:0.85rem;font-weight:600}.lot-info-value.hl{color:var(--accent-green)}
        
        /* CONTROLES MULTI-SELECT */
        .controls-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem}
        .control-box{background:var(--bg-card);border-radius:12px;padding:1rem;border:1px solid var(--border)}
        .control-label{font-size:0.7rem;text-transform:uppercase;color:var(--text-muted);margin-bottom:0.6rem;font-weight:600;display:flex;align-items:center;gap:0.5rem}
        .control-hint{font-size:0.65rem;color:var(--text-muted);font-weight:400;font-style:italic}
        .type-btns{display:flex;flex-wrap:wrap;gap:0.5rem}
        .type-btn{padding:0.6rem 1rem;border:2px solid var(--border);background:transparent;border-radius:25px;cursor:pointer;font-family:inherit;font-size:0.85rem;color:var(--text-secondary);display:flex;align-items:center;gap:0.4rem;transition:all 0.2s}
        .type-btn:hover{border-color:var(--text-muted);background:var(--bg-secondary)}
        .type-btn .axis-badge{font-size:0.6rem;font-weight:700;padding:0.1rem 0.35rem;border-radius:4px;background:var(--bg-secondary);color:var(--text-muted);margin-left:0.25rem}
        
        /* √âtats actifs pour chaque type */
        .type-btn.active-y1{border-color:var(--accent-green);background:var(--accent-green-light);color:var(--accent-green)}
        .type-btn.active-y1 .axis-badge{background:var(--accent-green);color:white}
        .type-btn.active-y2{border-color:var(--accent-amber);background:var(--accent-amber-light);color:var(--accent-amber)}
        .type-btn.active-y2 .axis-badge{background:var(--accent-amber);color:white}
        
        .type-btn[data-type="poids"].active-y1,.type-btn[data-type="poids"].active-y2{border-color:var(--accent-green);background:var(--accent-green-light);color:var(--accent-green)}
        .type-btn[data-type="mortalite"].active-y1,.type-btn[data-type="mortalite"].active-y2{border-color:var(--accent-amber);background:var(--accent-amber-light);color:var(--accent-amber)}
        .type-btn[data-type="aliment"].active-y1,.type-btn[data-type="aliment"].active-y2{border-color:var(--accent-blue);background:var(--accent-blue-light);color:var(--accent-blue)}
        .type-btn[data-type="oeufs"].active-y1,.type-btn[data-type="oeufs"].active-y2{border-color:var(--accent-purple);background:var(--accent-purple-light);color:var(--accent-purple)}
        
        .period-btns{display:flex;gap:0.4rem}
        .period-btn{flex:1;padding:0.6rem;border:1px solid var(--border);background:transparent;border-radius:6px;cursor:pointer;font-family:inherit;font-size:0.85rem;color:var(--text-secondary);transition:all 0.2s}
        .period-btn:hover{border-color:var(--text-muted)}
        .period-btn.active{background:var(--bg-secondary);border-color:var(--accent-blue);color:var(--text-primary)}
        
        /* GRAPHIQUE */
        .chart-card{background:var(--bg-card);border-radius:16px;padding:1.5rem;border:1px solid var(--border);margin-bottom:1rem}
        .chart-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem;flex-wrap:wrap;gap:1rem}
        .chart-title-section{}
        .chart-title{font-size:1.2rem;font-weight:600;margin-bottom:0.25rem}
        .chart-subtitle{color:var(--text-muted);font-size:0.85rem}
        .chart-legend{display:flex;flex-wrap:wrap;gap:1rem;align-items:center}
        .legend-item{display:flex;align-items:center;gap:0.5rem;font-size:0.8rem;color:var(--text-secondary)}
        .legend-line{width:24px;height:3px;border-radius:2px}
        .legend-area{width:24px;height:14px;border-radius:3px;opacity:0.4}
        .chart-container{height:400px;position:relative}
        
        /* STATS */
        .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1rem}
        .stats-card{background:var(--bg-card);border-radius:12px;padding:1rem;border:1px solid var(--border)}
        .stats-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem}
        .stats-title{font-size:0.7rem;text-transform:uppercase;color:var(--text-muted);font-weight:600}
        .stats-icon{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:0.9rem}
        .stats-icon.green{background:var(--accent-green-light)}.stats-icon.amber{background:var(--accent-amber-light)}.stats-icon.blue{background:var(--accent-blue-light)}.stats-icon.purple{background:var(--accent-purple-light)}
        .stats-value{font-size:1.5rem;font-weight:700}.stats-unit{font-size:0.85rem;color:var(--text-secondary)}
        .stats-detail{font-size:0.75rem;color:var(--text-muted);margin-top:0.25rem}
        
        .empty-box{text-align:center;padding:3rem 1.5rem}.empty-icon{font-size:3rem;margin-bottom:0.75rem}
        .debug-box{background:#1e293b;border:1px solid var(--border);border-radius:8px;padding:0.75rem;margin-top:1rem;font-family:'JetBrains Mono',monospace;font-size:0.6rem;color:var(--text-muted);max-height:100px;overflow-y:auto}
        .footer{margin-top:1.5rem;padding-top:1rem;border-top:1px solid var(--border);font-size:0.75rem;color:var(--text-muted)}
        .hidden{display:none !important}
        @media(max-width:900px){.controls-row{grid-template-columns:1fr}.chart-container{height:300px}}
    </style>
</head>
<body>
<div class="page active" id="pageLogin">
    <div class="login-container">
        <div class="login-logo"><div class="login-logo-icon">üêî</div><h1>Production Avicole</h1><p>v7 - Multi-courbes</p></div>
        <div class="card">
            <div class="alert" id="loginAlert"></div>
            <div class="form-group"><label class="form-label">Email</label><input type="text" class="form-input" id="loginUser" placeholder="email@exemple.com"></div>
            <div class="form-group"><label class="form-label">Mot de passe</label><input type="password" class="form-input" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
            <button class="btn btn-primary" id="loginBtn">Se connecter</button>
            <div class="status-box" id="dbStatus">Base: <span id="dbStatusText">...</span></div>
        </div>
    </div>
</div>
<div class="page" id="pageConfig">
    <div class="config-container">
        <div class="login-logo"><div class="login-logo-icon" style="background:linear-gradient(135deg,var(--accent-amber),var(--accent-red))">‚öôÔ∏è</div><h1>Configuration</h1></div>
        <div class="card">
            <div class="alert" id="configAlert"></div>
            <div class="config-section">
                <div class="config-title">üîå Supabase</div>
                <div class="form-group"><label class="form-label">URL</label><input type="url" class="form-input" id="cfgUrl" placeholder="https://xxx.supabase.co"></div>
                <div class="form-group"><label class="form-label">Cl√© Anon</label><input type="text" class="form-input" id="cfgKey" placeholder="eyJ..."></div>
                <div class="btn-group"><button class="btn btn-secondary" id="btnTestSupa">üîç Tester</button><button class="btn btn-primary" id="btnSaveSupa">üíæ Sauver</button></div>
            </div>
            <span class="back-link" id="btnBack">‚Üê Retour</span>
        </div>
    </div>
</div>
<div class="session-bar" id="sessionBar">
    <span class="session-user" id="sessionUser">üë§</span>
    <span class="session-role" id="sessionRole">-</span>
    <button class="session-btn hidden" id="btnConfig">‚öôÔ∏è</button>
    <button class="session-btn" id="btnLogout">D√©connexion</button>
</div>
<div class="page page-app" id="pageApp">
    <div class="container">
        <header class="header">
            <div class="header-left"><div class="logo">üêî</div><div><h1>Suivi Production</h1><p class="header-subtitle">Analyse multi-indicateurs</p></div></div>
            <div class="last-update">MAJ: <span id="lastUpdate">--</span></div>
        </header>
        
        <div class="farmer-card">
            <div class="farmer-icon">üë®‚Äçüåæ</div>
            <div class="farmer-info"><div class="farmer-label">√âleveur</div><div class="farmer-name" id="farmerName">--</div><div class="farmer-company" id="farmerCompany">--</div></div>
            <div class="farmer-details"><div class="farmer-detail"><span class="detail-label">Code</span><span class="detail-value" id="farmerCode">--</span></div><div class="farmer-detail"><span class="detail-label">Site</span><span class="detail-value" id="farmerSite">--</span></div></div>
        </div>
        
        <div class="selectors-card">
            <div class="selectors-grid">
                <div class="selector-group"><label>√âleveur</label><select class="selector-select" id="selEleveur"><option value="">-- Choisir --</option></select></div>
                <div class="selector-group"><label>Site</label><select class="selector-select" id="selSite" disabled><option value="">-- Choisir --</option></select></div>
                <div class="selector-group"><label>B√¢timent</label><select class="selector-select" id="selBatiment" disabled><option value="">-- Choisir --</option></select></div>
                <div class="selector-group"><label>Lot</label><select class="selector-select" id="selLot" disabled><option value="">-- Choisir --</option></select></div>
            </div>
        </div>
        
        <div class="lot-info-card hidden" id="lotInfoCard">
            <div class="lot-info-title">üê• Lot s√©lectionn√©</div>
            <div class="lot-info-grid">
                <div class="lot-info-item"><div class="lot-info-label">Code</div><div class="lot-info-value" id="lotCode">--</div></div>
                <div class="lot-info-item"><div class="lot-info-label">Souche</div><div class="lot-info-value" id="lotSouche">--</div></div>
                <div class="lot-info-item"><div class="lot-info-label">Effectif</div><div class="lot-info-value hl" id="lotEffectif">--</div></div>
                <div class="lot-info-item"><div class="lot-info-label">Date</div><div class="lot-info-value" id="lotDate">--</div></div>
                <div class="lot-info-item"><div class="lot-info-label">√Çge</div><div class="lot-info-value hl" id="lotAge">--</div></div>
                <div class="lot-info-item"><div class="lot-info-label">Statut</div><div class="lot-info-value" id="lotStatut">--</div></div>
            </div>
        </div>
        
        <div class="controls-row hidden" id="controlsRow">
            <div class="control-box">
                <div class="control-label">Type de donn√©es <span class="control-hint">(s√©lectionnez 1 ou 2 indicateurs)</span></div>
                <div class="type-btns" id="typeBtns">
                    <button class="type-btn active-y1" data-type="poids">üìà Croissance en poids <span class="axis-badge">Y1</span></button>
                    <button class="type-btn" data-type="mortalite">‚ö†Ô∏è Mortalit√© <span class="axis-badge">Y2</span></button>
                    <button class="type-btn" data-type="oeufs">ü•ö Nombre ≈ìufs pondus <span class="axis-badge">Y2</span></button>
                </div>
            </div>
            <div class="control-box">
                <div class="control-label">P√©riode d'analyse</div>
                <div class="period-btns" id="periodBtns">
                    <button class="period-btn" data-period="7">1 sem.</button>
                    <button class="period-btn" data-period="28">4 sem.</button>
                    <button class="period-btn active" data-period="56">8 sem.</button>
                    <button class="period-btn" data-period="all">Cycle complet</button>
                </div>
            </div>
        </div>
        
        <div class="chart-card hidden" id="chartCard">
            <div class="chart-header">
                <div class="chart-title-section">
                    <div class="chart-title" id="chartTitle">Croissance en poids</div>
                    <div class="chart-subtitle" id="chartSubtitle">Comparaison sur deux axes</div>
                </div>
                <div class="chart-legend" id="chartLegend">
                    <!-- Dynamique -->
                </div>
            </div>
            <div class="chart-container"><canvas id="mainChart"></canvas></div>
        </div>
        
        <div class="stats-row hidden" id="statsRow">
            <div class="stats-card" id="statsCard1">
                <div class="stats-header"><span class="stats-title" id="statsTitle1">Poids</span><div class="stats-icon green" id="statsIcon1">üìà</div></div>
                <div class="stats-value"><span id="statsValue1">--</span><span class="stats-unit" id="statsUnit1">g</span></div>
                <div class="stats-detail" id="statsDetail1">--</div>
            </div>
            <div class="stats-card" id="statsCard2">
                <div class="stats-header"><span class="stats-title" id="statsTitle2">Mortalit√©</span><div class="stats-icon amber" id="statsIcon2">‚ö†Ô∏è</div></div>
                <div class="stats-value"><span id="statsValue2">--</span><span class="stats-unit" id="statsUnit2">%</span></div>
                <div class="stats-detail" id="statsDetail2">--</div>
            </div>
            <div class="stats-card">
                <div class="stats-header"><span class="stats-title">Donn√©es charg√©es</span><div class="stats-icon blue">üìä</div></div>
                <div class="stats-value"><span id="dataCount">0</span><span class="stats-unit">pts</span></div>
                <div class="stats-detail" id="dataPeriod">--</div>
            </div>
        </div>
        
        <div class="chart-card" id="emptyBox"><div class="empty-box"><div class="empty-icon">üìä</div><h3>S√©lectionnez un lot</h3><p style="color:var(--text-secondary)">√âleveur ‚Üí Site ‚Üí B√¢timent ‚Üí Lot</p></div></div>
        
        <div class="debug-box"><strong>Debug:</strong> <span id="debugLog">Pr√™t</span></div>
        <footer class="footer">v7.0 - Multi-indicateurs avec zone de tol√©rance</footer>
    </div>
</div>
<script>
(function(){
    var ADMIN = {user: 'admin', pass: 'admin2024!'};
    var supabaseClient = null;
    var currentUser = null;
    var isLocalAdmin = false;
    var mainChart = null;
    var lotData = {poids: [], mortalite: [], aliment: [], oeufs: []};
    var standardsData = {poids: [], mortalite: [], aliment: [], oeufs: []};
    
    // Multi-s√©lection: Y1 et Y2
    var selectedTypes = ['poids']; // Par d√©faut poids sur Y1
    var currentPeriod = '56';
    var currentLotInfo = null;
    
    // Config des types
    var TYPE_CONFIG = {
        poids: { label: 'Croissance en poids', unit: 'g', color: '#10b981', icon: 'üìà', field: 'poids_moyen', stdMin: 'poids_min', stdMax: 'poids_max', stdCible: 'poids_cible' },
        mortalite: { label: 'Mortalit√©', unit: 'morts', color: '#f59e0b', icon: '‚ö†Ô∏è', field: 'nombre_morts', stdMin: 'mortalite_min', stdMax: 'mortalite_max', stdCible: 'mortalite_cible' },
        oeufs: { label: 'Nombre ≈ìufs pondus', unit: '≈ìufs', color: '#8b5cf6', icon: 'ü•ö', field: 'nombre_oeufs', stdMin: 'taux_ponte_min', stdMax: 'taux_ponte_max', stdCible: 'taux_ponte_cible' },
        aliment: { label: 'Consommation aliment', unit: 'g', color: '#3b82f6', icon: 'üåæ', field: 'conso_par_animal', stdMin: 'conso_min', stdMax: 'conso_max', stdCible: 'conso_cible' }
    };

    function $(id) { return document.getElementById(id); }
    function log(m) { console.log('[APP]', m); var e = $('debugLog'); if (e) e.innerHTML = m + ' | ' + e.innerHTML.substring(0, 300); }
    function showPage(id) { document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); }); $(id).classList.add('active'); }
    function showAlert(id, type, msg) { var e = $(id); if (e) { e.className = 'alert alert-' + type + ' show'; e.innerHTML = msg; } }
    function loadCfg() { try { return JSON.parse(localStorage.getItem('avicole_cfg') || '{}'); } catch (e) { return {}; } }
    function saveCfg(url, key) { localStorage.setItem('avicole_cfg', JSON.stringify({url: url, key: key})); }
    function isSupabaseLoaded() { return typeof window.supabase !== 'undefined' && window.supabase !== null && typeof window.supabase.createClient === 'function'; }

    function initSupabase() {
        var cfg = loadCfg();
        if (!isSupabaseLoaded()) { $('dbStatus').className = 'status-box warning'; $('dbStatusText').textContent = 'SDK...'; return false; }
        if (cfg.url && cfg.key) {
            try { supabaseClient = window.supabase.createClient(cfg.url, cfg.key); $('dbStatus').className = 'status-box ok'; $('dbStatusText').textContent = 'OK ‚úì'; return true; }
            catch (e) { log('Err: ' + e.message); }
        }
        $('dbStatus').className = 'status-box warning'; $('dbStatusText').textContent = 'Non configur√©';
        return false;
    }

    function testSupabase() {
        var url = $('cfgUrl').value.trim(), key = $('cfgKey').value.trim();
        if (!url || !key) { showAlert('configAlert', 'error', '‚ùå Remplissez les champs'); return; }
        showAlert('configAlert', 'info', '‚è≥ Test...');
        try {
            var c = window.supabase.createClient(url, key);
            c.from('eleveurs').select('id').limit(1).then(function(r) {
                if (r.error) showAlert('configAlert', 'error', '‚ùå ' + r.error.message);
                else showAlert('configAlert', 'success', '‚úÖ OK!');
            });
        } catch (e) { showAlert('configAlert', 'error', '‚ùå ' + e.message); }
    }

    function saveSupabaseCfg() {
        var url = $('cfgUrl').value.trim(), key = $('cfgKey').value.trim();
        if (!url || !key) { showAlert('configAlert', 'error', '‚ùå Remplissez les champs'); return; }
        saveCfg(url, key);
        if (initSupabase()) showAlert('configAlert', 'success', '‚úÖ Sauv√©!');
    }

    function doLogin() {
        var user = $('loginUser').value.trim(), pass = $('loginPass').value, btn = $('loginBtn');
        if (!user || !pass) { showAlert('loginAlert', 'error', '‚ùå Remplissez les champs'); return; }
        if (user === ADMIN.user && pass === ADMIN.pass) {
            isLocalAdmin = true; currentUser = {nom: 'Admin'};
            $('sessionUser').textContent = 'üëë Admin'; $('sessionRole').textContent = 'CONFIG'; $('sessionRole').className = 'session-role config';
            $('btnConfig').classList.remove('hidden'); $('sessionBar').style.display = 'flex';
            setTimeout(function() { showPage('pageConfig'); }, 200); return;
        }
        if (!supabaseClient) { showAlert('loginAlert', 'error', '‚ùå Base non config. Admin: admin/admin2024!'); return; }
        btn.disabled = true;
        supabaseClient.from('users').select('*').eq('email', user).eq('is_active', true).single().then(function(res) {
            if (res.error || !res.data) throw new Error('Utilisateur non trouv√©');
            if ((res.data.password_hash || '') !== pass) throw new Error('Mot de passe incorrect');
            currentUser = res.data;
            $('sessionUser').textContent = 'üë§ ' + (res.data.prenom || '') + ' ' + res.data.nom;
            $('sessionRole').textContent = (res.data.role || 'eleveur').toUpperCase();
            $('sessionRole').className = 'session-role ' + (res.data.role || 'eleveur');
            $('sessionBar').style.display = 'flex';
            loadEleveurs();
            setTimeout(function() { showPage('pageApp'); }, 200);
        }).catch(function(e) { showAlert('loginAlert', 'error', '‚ùå ' + e.message); }).finally(function() { btn.disabled = false; });
    }

    function doLogout() { currentUser = null; $('sessionBar').style.display = 'none'; showPage('pageLogin'); }

    function loadEleveurs() {
        if (!supabaseClient) return;
        supabaseClient.from('eleveurs').select('*').eq('is_active', true).order('nom').then(function(res) {
            var sel = $('selEleveur'); sel.innerHTML = '<option value="">-- S√©lectionner --</option>';
            (res.data || []).forEach(function(e) {
                var opt = document.createElement('option'); opt.value = e.id;
                opt.setAttribute('data-json', JSON.stringify(e));
                opt.textContent = e.nom + ' ' + (e.prenom || '') + ' - ' + e.code_eleveur;
                sel.appendChild(opt);
            });
            if (res.data && res.data.length === 1) { sel.value = res.data[0].id; onEleveurChange(); }
            $('lastUpdate').textContent = new Date().toLocaleString('fr-FR');
        });
    }

    function onEleveurChange() {
        var id = $('selEleveur').value, selSite = $('selSite');
        selSite.innerHTML = '<option value="">-- S√©lectionner --</option>'; selSite.disabled = !id;
        $('selBatiment').innerHTML = '<option value="">-- S√©lectionner --</option>'; $('selBatiment').disabled = true;
        $('selLot').innerHTML = '<option value="">-- S√©lectionner --</option>'; $('selLot').disabled = true;
        hideDataCards();
        if (!id) return;
        var opt = document.querySelector('#selEleveur option[value="' + id + '"]');
        if (opt) { try { var e = JSON.parse(opt.getAttribute('data-json')); $('farmerName').textContent = e.nom + ' ' + (e.prenom || ''); $('farmerCompany').textContent = e.raison_sociale || '--'; $('farmerCode').textContent = e.code_eleveur || '--'; } catch (er) {} }
        supabaseClient.from('sites').select('*').eq('eleveur_id', id).eq('is_active', true).order('nom').then(function(res) {
            (res.data || []).forEach(function(s) { var opt = document.createElement('option'); opt.value = s.id; opt.setAttribute('data-json', JSON.stringify(s)); opt.textContent = s.nom + (s.ville ? ' (' + s.ville + ')' : ''); selSite.appendChild(opt); });
            if (res.data && res.data.length === 1) { selSite.value = res.data[0].id; onSiteChange(); }
        });
    }

    function onSiteChange() {
        var id = $('selSite').value, selBat = $('selBatiment');
        selBat.innerHTML = '<option value="">-- S√©lectionner --</option>'; selBat.disabled = !id;
        $('selLot').innerHTML = '<option value="">-- S√©lectionner --</option>'; $('selLot').disabled = true;
        hideDataCards();
        if (!id) return;
        var opt = document.querySelector('#selSite option[value="' + id + '"]');
        if (opt) { try { var s = JSON.parse(opt.getAttribute('data-json')); $('farmerSite').textContent = s.nom + (s.ville ? ' - ' + s.ville : ''); } catch (er) {} }
        supabaseClient.from('batiments').select('*').eq('site_id', id).eq('is_active', true).order('nom').then(function(res) {
            (res.data || []).forEach(function(b) { var opt = document.createElement('option'); opt.value = b.id; opt.textContent = b.nom + (b.capacite ? ' (' + b.capacite + ')' : ''); selBat.appendChild(opt); });
            if (res.data && res.data.length === 1) { selBat.value = res.data[0].id; onBatimentChange(); }
        });
    }

    function onBatimentChange() {
        var id = $('selBatiment').value, selLot = $('selLot');
        selLot.innerHTML = '<option value="">-- S√©lectionner --</option>'; selLot.disabled = !id;
        hideDataCards();
        if (!id) return;
        supabaseClient.from('lots').select('*, souches(nom)').eq('batiment_id', id).order('date_mise_place', {ascending: false}).then(function(res) {
            (res.data || []).forEach(function(l) {
                var opt = document.createElement('option'); opt.value = l.id; opt.setAttribute('data-json', JSON.stringify(l));
                opt.textContent = (l.statut === 'actif' ? 'üü¢ ' : '‚ö™ ') + l.code_lot + ' - ' + (l.souches ? l.souches.nom : 'N/A');
                selLot.appendChild(opt);
            });
            var actif = (res.data || []).find(function(x) { return x.statut === 'actif'; });
            if (actif) { selLot.value = actif.id; onLotChange(); }
        });
    }

    function onLotChange() {
        var id = $('selLot').value;
        if (!id) { hideDataCards(); return; }
        var opt = document.querySelector('#selLot option[value="' + id + '"]');
        var lot = {}; try { lot = JSON.parse(opt.getAttribute('data-json') || '{}'); } catch (e) {}
        currentLotInfo = lot;
        $('lotCode').textContent = lot.code_lot || '--';
        $('lotSouche').textContent = (lot.souches && lot.souches.nom) ? lot.souches.nom : '--';
        $('lotEffectif').textContent = lot.effectif_depart ? lot.effectif_depart.toLocaleString() : '--';
        $('lotDate').textContent = lot.date_mise_place ? new Date(lot.date_mise_place).toLocaleDateString('fr-FR') : '--';
        if (lot.date_mise_place) { $('lotAge').textContent = Math.floor((new Date() - new Date(lot.date_mise_place)) / 86400000) + ' jours'; }
        $('lotStatut').textContent = lot.statut || '--';
        log('Chargement lot: ' + id);
        
        Promise.all([
            supabaseClient.from('donnees_poids').select('*').eq('lot_id', id).order('jour_age'),
            supabaseClient.from('donnees_mortalite').select('*').eq('lot_id', id).order('jour_age'),
            supabaseClient.from('donnees_aliment').select('*').eq('lot_id', id).order('jour_age'),
            supabaseClient.from('donnees_oeufs').select('*').eq('lot_id', id).order('jour_age')
        ]).then(function(results) {
            lotData.poids = results[0].data || [];
            lotData.mortalite = results[1].data || [];
            lotData.aliment = results[2].data || [];
            lotData.oeufs = results[3].data || [];
            log('Donn√©es: P=' + lotData.poids.length + ' M=' + lotData.mortalite.length + ' O=' + lotData.oeufs.length);
            if (lot.souche_id) loadStandards(lot.souche_id);
            else { showDataCards(); updateUI(); }
        });
    }

    function loadStandards(soucheId) {
        Promise.all([
            supabaseClient.from('standards_poids').select('*').eq('souche_id', soucheId).order('jour_age'),
            supabaseClient.from('standards_mortalite').select('*').eq('souche_id', soucheId).order('jour_age'),
            supabaseClient.from('standards_aliment').select('*').eq('souche_id', soucheId).order('jour_age'),
            supabaseClient.from('standards_oeufs').select('*').eq('souche_id', soucheId).order('jour_age')
        ]).then(function(results) {
            standardsData.poids = results[0].data || [];
            standardsData.mortalite = results[1].data || [];
            standardsData.aliment = results[2].data || [];
            standardsData.oeufs = results[3].data || [];
            log('Standards: P=' + standardsData.poids.length);
            showDataCards();
            updateUI();
        });
    }

    function showDataCards() {
        $('lotInfoCard').classList.remove('hidden');
        $('controlsRow').classList.remove('hidden');
        $('chartCard').classList.remove('hidden');
        $('statsRow').classList.remove('hidden');
        $('emptyBox').classList.add('hidden');
    }

    function hideDataCards() {
        $('lotInfoCard').classList.add('hidden');
        $('controlsRow').classList.add('hidden');
        $('chartCard').classList.add('hidden');
        $('statsRow').classList.add('hidden');
        $('emptyBox').classList.remove('hidden');
    }

    function updateUI() {
        updateChart();
        updateStats();
    }

    function updateStats() {
        var type1 = selectedTypes[0];
        var type2 = selectedTypes[1];
        var cfg1 = TYPE_CONFIG[type1];
        var data1 = lotData[type1] || [];
        
        // Stats 1
        $('statsTitle1').textContent = cfg1.label;
        $('statsIcon1').textContent = cfg1.icon;
        if (data1.length > 0) {
            var last1 = data1[data1.length - 1];
            var val1 = parseFloat(last1[cfg1.field]) || 0;
            $('statsValue1').textContent = val1.toFixed(type1 === 'poids' ? 0 : 1);
            $('statsUnit1').textContent = cfg1.unit;
            $('statsDetail1').textContent = 'Jour ' + last1.jour_age;
        } else {
            $('statsValue1').textContent = '--';
            $('statsDetail1').textContent = 'Pas de donn√©es';
        }
        
        // Stats 2
        if (type2) {
            var cfg2 = TYPE_CONFIG[type2];
            var data2 = lotData[type2] || [];
            $('statsCard2').classList.remove('hidden');
            $('statsTitle2').textContent = cfg2.label;
            $('statsIcon2').textContent = cfg2.icon;
            if (data2.length > 0) {
                var last2 = data2[data2.length - 1];
                var val2 = parseFloat(last2[cfg2.field]) || 0;
                $('statsValue2').textContent = val2.toFixed(1);
                $('statsUnit2').textContent = cfg2.unit;
                $('statsDetail2').textContent = 'Jour ' + last2.jour_age;
            } else {
                $('statsValue2').textContent = '--';
                $('statsDetail2').textContent = 'Pas de donn√©es';
            }
        } else {
            $('statsCard2').classList.add('hidden');
        }
        
        // Compteur total
        var total = 0;
        selectedTypes.forEach(function(t) { total += (lotData[t] || []).length; });
        $('dataCount').textContent = total;
        $('dataPeriod').textContent = currentPeriod === 'all' ? 'Cycle complet' : currentPeriod + ' jours';
    }

    function updateChart() {
        var ctx = $('mainChart');
        if (!ctx) return;
        ctx = ctx.getContext('2d');
        if (mainChart) mainChart.destroy();
        
        var type1 = selectedTypes[0];
        var type2 = selectedTypes[1];
        var cfg1 = TYPE_CONFIG[type1];
        var data1 = lotData[type1] || [];
        var std1 = standardsData[type1] || [];
        
        if (data1.length === 0) {
            $('chartTitle').textContent = 'Aucune donn√©e';
            $('chartSubtitle').textContent = '';
            return;
        }
        
        // Filtrer par p√©riode
        var filteredData1 = filterByPeriod(data1);
        var labels = filteredData1.map(function(d) { return 'J' + d.jour_age; });
        var jourAges = filteredData1.map(function(d) { return d.jour_age; });
        
        // Titre
        var title = cfg1.label;
        if (type2) title += ' vs ' + TYPE_CONFIG[type2].label;
        $('chartTitle').textContent = title;
        $('chartSubtitle').textContent = 'Comparaison sur ' + (type2 ? 'deux axes' : 'un axe');
        
        var datasets = [];
        
        // === COURBE 1 (Y1) ===
        var values1 = filteredData1.map(function(d) { return parseFloat(d[cfg1.field]) || 0; });
        
        // Zone de tol√©rance pour Y1 (min-max des standards)
        var stdMin1 = [], stdMax1 = [];
        jourAges.forEach(function(ja) {
            var s = std1.find(function(x) { return x.jour_age === ja; });
            if (s) {
                stdMin1.push(parseFloat(s[cfg1.stdMin]) || null);
                stdMax1.push(parseFloat(s[cfg1.stdMax]) || null);
            } else {
                stdMin1.push(null);
                stdMax1.push(null);
            }
        });
        
        // Zone de tol√©rance Y1 (aire entre min et max)
        if (stdMin1.some(function(v) { return v !== null; })) {
            datasets.push({
                label: 'Zone tol√©rance ' + cfg1.label,
                data: stdMax1,
                borderColor: 'transparent',
                backgroundColor: cfg1.color + '20',
                fill: '+1',
                pointRadius: 0,
                yAxisID: 'y1',
                order: 3
            });
            datasets.push({
                label: '_stdMin1',
                data: stdMin1,
                borderColor: cfg1.color + '40',
                borderWidth: 1,
                borderDash: [4, 4],
                backgroundColor: 'transparent',
                fill: false,
                pointRadius: 0,
                yAxisID: 'y1',
                order: 2
            });
            datasets.push({
                label: '_stdMax1',
                data: stdMax1,
                borderColor: cfg1.color + '40',
                borderWidth: 1,
                borderDash: [4, 4],
                backgroundColor: 'transparent',
                fill: false,
                pointRadius: 0,
                yAxisID: 'y1',
                order: 2
            });
        }
        
        // Courbe principale Y1
        datasets.push({
            label: cfg1.label,
            data: values1,
            borderColor: cfg1.color,
            backgroundColor: cfg1.color,
            borderWidth: 2.5,
            tension: 0.3,
            fill: false,
            pointRadius: values1.length > 50 ? 0 : 3,
            pointBackgroundColor: cfg1.color,
            yAxisID: 'y1',
            order: 1
        });
        
        // === COURBE 2 (Y2) ===
        var scales = {
            x: { grid: { color: 'rgba(45,58,82,0.3)' }, ticks: { color: '#94a3b8', maxTicksLimit: 15 }, title: { display: true, text: 'Jours du cycle', color: '#64748b' } },
            y1: { 
                type: 'linear', 
                position: 'left', 
                grid: { color: 'rgba(45,58,82,0.3)' }, 
                ticks: { color: cfg1.color, callback: function(v) { return v + ' ' + cfg1.unit; } },
                title: { display: true, text: cfg1.label + ' (' + cfg1.unit + ')', color: cfg1.color }
            }
        };
        
        if (type2) {
            var cfg2 = TYPE_CONFIG[type2];
            var data2 = lotData[type2] || [];
            var std2 = standardsData[type2] || [];
            var filteredData2 = filterByPeriod(data2);
            
            // Mapper les donn√©es sur les m√™mes jours
            var values2 = jourAges.map(function(ja) {
                var d = filteredData2.find(function(x) { return x.jour_age === ja; });
                return d ? (parseFloat(d[cfg2.field]) || 0) : null;
            });
            
            // Zone de tol√©rance Y2
            var stdMin2 = [], stdMax2 = [];
            jourAges.forEach(function(ja) {
                var s = std2.find(function(x) { return x.jour_age === ja; });
                if (s) {
                    stdMin2.push(parseFloat(s[cfg2.stdMin]) || null);
                    stdMax2.push(parseFloat(s[cfg2.stdMax]) || null);
                } else {
                    stdMin2.push(null);
                    stdMax2.push(null);
                }
            });
            
            // Courbe principale Y2
            datasets.push({
                label: cfg2.label,
                data: values2,
                borderColor: cfg2.color,
                backgroundColor: cfg2.color,
                borderWidth: 2.5,
                tension: 0.3,
                fill: false,
                pointRadius: values2.length > 50 ? 0 : 3,
                pointBackgroundColor: cfg2.color,
                yAxisID: 'y2',
                order: 1
            });
            
            scales.y2 = {
                type: 'linear',
                position: 'right',
                grid: { drawOnChartArea: false },
                ticks: { color: cfg2.color, callback: function(v) { return v + ' ' + cfg2.unit; } },
                title: { display: true, text: cfg2.label + ' (' + cfg2.unit + ')', color: cfg2.color }
            };
        }
        
        // L√©gende
        updateLegend(type1, type2);
        
        mainChart = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(26,34,54,0.95)',
                        padding: 12,
                        titleFont: { size: 13 },
                        bodyFont: { size: 12 },
                        callbacks: {
                            label: function(c) {
                                if (c.dataset.label.startsWith('_') || c.dataset.label.startsWith('Zone')) return null;
                                return c.dataset.label + ': ' + c.parsed.y;
                            }
                        }
                    }
                },
                scales: scales
            }
        });
    }
    
    function filterByPeriod(data) {
        if (currentPeriod === 'all' || !data.length) return data;
        var days = parseInt(currentPeriod);
        return data.slice(-days);
    }
    
    function updateLegend(type1, type2) {
        var cfg1 = TYPE_CONFIG[type1];
        var html = '<div class="legend-item"><span class="legend-line" style="background:' + cfg1.color + '"></span>' + cfg1.label + '</div>';
        if (type2) {
            var cfg2 = TYPE_CONFIG[type2];
            html += '<div class="legend-item"><span class="legend-line" style="background:' + cfg2.color + '"></span>' + cfg2.label + '</div>';
        }
        html += '<div class="legend-item"><span class="legend-area" style="background:' + cfg1.color + '"></span>Zone tol√©rance</div>';
        $('chartLegend').innerHTML = html;
    }
    
    function updateTypeButtons() {
        document.querySelectorAll('#typeBtns .type-btn').forEach(function(btn) {
            var type = btn.getAttribute('data-type');
            var badge = btn.querySelector('.axis-badge');
            btn.classList.remove('active-y1', 'active-y2');
            badge.textContent = '';
            
            if (selectedTypes[0] === type) {
                btn.classList.add('active-y1');
                badge.textContent = 'Y1';
            } else if (selectedTypes[1] === type) {
                btn.classList.add('active-y2');
                badge.textContent = 'Y2';
            }
        });
    }

    function onTypeClick(e) {
        var btn = e.currentTarget;
        var type = btn.getAttribute('data-type');
        
        var idx = selectedTypes.indexOf(type);
        if (idx === 0) {
            // D√©j√† Y1: si seul, ne rien faire. Si Y2 existe, le passer en Y1
            if (selectedTypes.length > 1) {
                selectedTypes = [selectedTypes[1]];
            }
        } else if (idx === 1) {
            // D√©j√† Y2: le retirer
            selectedTypes = [selectedTypes[0]];
        } else {
            // Pas s√©lectionn√©
            if (selectedTypes.length < 2) {
                selectedTypes.push(type);
            } else {
                // Remplacer Y2
                selectedTypes[1] = type;
            }
        }
        
        updateTypeButtons();
        updateUI();
    }

    document.addEventListener('DOMContentLoaded', function() {
        log('App v7 d√©marr√©e');
        var cfg = loadCfg();
        if (cfg.url) $('cfgUrl').value = cfg.url;
        if (cfg.key) $('cfgKey').value = cfg.key;
        initSupabase();
        
        $('loginBtn').addEventListener('click', doLogin);
        $('loginPass').addEventListener('keypress', function(e) { if (e.key === 'Enter') doLogin(); });
        $('btnTestSupa').addEventListener('click', testSupabase);
        $('btnSaveSupa').addEventListener('click', saveSupabaseCfg);
        $('btnBack').addEventListener('click', function() { showPage('pageLogin'); });
        $('btnLogout').addEventListener('click', doLogout);
        $('btnConfig').addEventListener('click', function() { showPage('pageConfig'); });
        
        $('selEleveur').addEventListener('change', onEleveurChange);
        $('selSite').addEventListener('change', onSiteChange);
        $('selBatiment').addEventListener('change', onBatimentChange);
        $('selLot').addEventListener('change', onLotChange);
        
        document.querySelectorAll('#typeBtns .type-btn').forEach(function(btn) {
            btn.addEventListener('click', onTypeClick);
        });
        
        document.querySelectorAll('#periodBtns .period-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#periodBtns .period-btn').forEach(function(b) { b.classList.remove('active'); });
                this.classList.add('active');
                currentPeriod = this.getAttribute('data-period');
                updateUI();
            });
        });
        
        updateTypeButtons();
    });
})();
</script>
</body>
</html>
