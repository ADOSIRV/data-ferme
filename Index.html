<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêî Avicole - Multi-Courbes v11</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --green: #22c55e;
            --green-light: rgba(34,197,94,0.15);
            --green-area: rgba(34,197,94,0.25);
            --orange: #f97316;
            --orange-light: rgba(249,115,22,0.15);
            --orange-area: rgba(249,115,22,0.25);
            --blue: #3b82f6;
            --blue-light: rgba(59,130,246,0.15);
            --blue-area: rgba(59,130,246,0.25);
            --purple: #a855f7;
            --purple-light: rgba(168,85,247,0.15);
            --purple-area: rgba(168,85,247,0.25);
            --text: #f8fafc;
            --text-dim: #94a3b8;
            --border: #475569;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text); min-height: 100vh; }
        
        .page { display: none; min-height: 100vh; }
        .page.active { display: flex; align-items: center; justify-content: center; }
        .page-app.active { display: block; }
        
        .login-box { width: 100%; max-width: 400px; padding: 2rem; }
        .login-header { text-align: center; margin-bottom: 2rem; }
        .login-icon { font-size: 4rem; margin-bottom: 1rem; }
        .login-title { font-size: 1.5rem; font-weight: 700; }
        .login-subtitle { color: var(--text-dim); margin-top: 0.5rem; }
        .card { background: var(--bg-card); border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border); }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-dim); margin-bottom: 0.4rem; text-transform: uppercase; }
        .form-input { width: 100%; padding: 0.8rem 1rem; background: var(--bg-input); border: 2px solid var(--border); border-radius: 10px; color: var(--text); font-size: 1rem; font-family: inherit; }
        .form-input:focus { outline: none; border-color: var(--blue); }
        .btn { width: 100%; padding: 1rem; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; font-family: inherit; }
        .btn-primary { background: linear-gradient(135deg, var(--green), var(--blue)); color: white; }
        .btn-secondary { background: var(--bg-input); color: var(--text); border: 2px solid var(--border); }
        .alert { padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; display: none; font-size: 0.85rem; }
        .alert.show { display: block; }
        .alert-error { background: rgba(239,68,68,0.15); border: 1px solid #ef4444; color: #ef4444; }
        .alert-success { background: var(--green-light); border: 1px solid var(--green); color: var(--green); }
        .alert-info { background: var(--blue-light); border: 1px solid var(--blue); color: var(--blue); }
        .status-box { text-align: center; margin-top: 1rem; padding: 0.7rem; background: var(--bg-input); border-radius: 8px; font-size: 0.85rem; }
        .status-box.ok { background: var(--green-light); color: var(--green); }
        .status-box.warn { background: var(--orange-light); color: var(--orange); }
        
        .config-box { width: 100%; max-width: 500px; padding: 2rem; }
        .config-section { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); }
        .config-section:last-of-type { border-bottom: none; }
        .config-title { font-weight: 600; color: var(--blue); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .btn-row { display: flex; gap: 0.75rem; margin-top: 1rem; }
        .btn-row .btn { flex: 1; }
        .back-link { display: block; text-align: center; margin-top: 1rem; color: var(--blue); cursor: pointer; }
        .config-note { font-size: 0.75rem; color: var(--text-dim); margin-top: 0.5rem; font-style: italic; }
        
        .session-bar { position: fixed; top: 1rem; right: 1rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 50px; padding: 0.5rem 1rem; display: none; align-items: center; gap: 0.75rem; font-size: 0.8rem; z-index: 1000; }
        .session-user { font-weight: 500; }
        .session-role { padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; }
        .session-role.eleveur { background: var(--green-light); color: var(--green); }
        .session-role.admin { background: var(--orange-light); color: var(--orange); }
        .session-role.technicien { background: var(--blue-light); color: var(--blue); }
        .session-btn { background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; padding: 0.3rem 0.6rem; color: var(--text-dim); font-size: 0.75rem; cursor: pointer; font-family: inherit; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
        
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        .app-logo { display: flex; align-items: center; gap: 1rem; }
        .logo-icon { font-size: 2.5rem; }
        .app-title { font-size: 1.4rem; font-weight: 700; }
        .app-subtitle { color: var(--text-dim); font-size: 0.85rem; }
        
        .eleveur-banner { background: linear-gradient(135deg, var(--green-light), var(--blue-light)); border: 2px solid var(--green); border-radius: 12px; padding: 1rem 1.5rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem; }
        .eleveur-banner-icon { font-size: 2.5rem; }
        .eleveur-banner-info { flex: 1; }
        .eleveur-banner-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-dim); }
        .eleveur-banner-name { font-size: 1.2rem; font-weight: 700; color: var(--green); }
        .eleveur-banner-detail { font-size: 0.85rem; color: var(--text-dim); }
        
        .selectors-card { background: var(--bg-card); border-radius: 12px; padding: 1rem; border: 1px solid var(--border); margin-bottom: 1rem; }
        .selectors-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .selector-group label { display: block; font-size: 0.7rem; text-transform: uppercase; color: var(--text-dim); margin-bottom: 0.3rem; font-weight: 600; }
        .selector-select { width: 100%; padding: 0.7rem 1rem; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.9rem; cursor: pointer; font-family: inherit; }
        .selector-select:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .lot-card { background: var(--bg-card); border-radius: 12px; padding: 1rem; border: 1px solid var(--border); margin-bottom: 1rem; }
        .lot-title { font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem; }
        .lot-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.5rem; }
        .lot-item { background: var(--bg-input); padding: 0.6rem; border-radius: 8px; }
        .lot-label { font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; }
        .lot-value { font-size: 0.9rem; font-weight: 600; }
        .lot-value.highlight { color: var(--green); }
        
        .controls-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 1rem; margin-bottom: 1rem; }
        .control-card { background: var(--bg-card); border-radius: 12px; padding: 1.25rem; border: 1px solid var(--border); }
        .control-title { font-size: 0.75rem; text-transform: uppercase; color: var(--text-dim); margin-bottom: 0.75rem; font-weight: 600; }
        .control-hint { font-weight: 400; font-style: italic; opacity: 0.7; }
        
        .indicator-btns { display: flex; flex-wrap: wrap; gap: 0.6rem; }
        .indicator-btn {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.7rem 1.1rem;
            border: 2px solid var(--border);
            background: transparent;
            border-radius: 30px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85rem;
            color: var(--text-dim);
            transition: all 0.2s ease;
        }
        .indicator-btn:hover { border-color: var(--text-dim); background: var(--bg-input); }
        .indicator-btn .icon { font-size: 1rem; }
        .indicator-btn .axis-tag {
            font-size: 0.6rem;
            font-weight: 700;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            background: var(--bg-input);
            color: var(--text-dim);
            min-width: 24px;
            text-align: center;
        }
        
        .indicator-btn.selected-y1 { border-color: var(--green); background: var(--green-light); color: var(--green); }
        .indicator-btn.selected-y1 .axis-tag { background: var(--green); color: white; }
        .indicator-btn.selected-y2 { border-color: var(--orange); background: var(--orange-light); color: var(--orange); }
        .indicator-btn.selected-y2 .axis-tag { background: var(--orange); color: white; }
        
        .period-btns { display: flex; gap: 0.5rem; }
        .period-btn {
            flex: 1;
            padding: 0.7rem;
            border: 1px solid var(--border);
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85rem;
            color: var(--text-dim);
            transition: all 0.2s;
        }
        .period-btn:hover { border-color: var(--text-dim); }
        .period-btn.active { background: var(--blue-light); border-color: var(--blue); color: var(--blue); font-weight: 600; }
        
        .chart-card { background: var(--bg-card); border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border); margin-bottom: 1rem; }
        .chart-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
        .chart-title { font-size: 1.3rem; font-weight: 700; }
        .chart-subtitle { color: var(--text-dim); font-size: 0.9rem; margin-top: 0.25rem; }
        
        .chart-legend { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
        .legend-item { display: flex; align-items: center; gap: 0.4rem; font-size: 0.8rem; color: var(--text-dim); }
        .legend-line { width: 24px; height: 3px; border-radius: 2px; }
        .legend-area { width: 24px; height: 14px; border-radius: 3px; }
        
        .chart-container { height: 420px; position: relative; }
        
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .stat-card { background: var(--bg-card); border-radius: 12px; padding: 1rem; border: 1px solid var(--border); }
        .stat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .stat-title { font-size: 0.7rem; text-transform: uppercase; color: var(--text-dim); font-weight: 600; }
        .stat-icon { font-size: 1.2rem; }
        .stat-value { font-size: 1.8rem; font-weight: 700; }
        .stat-unit { font-size: 1rem; color: var(--text-dim); margin-left: 0.25rem; }
        .stat-detail { font-size: 0.8rem; color: var(--text-dim); margin-top: 0.25rem; }
        
        .empty-state { text-align: center; padding: 4rem 2rem; }
        .empty-icon { font-size: 4rem; margin-bottom: 1rem; }
        .empty-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem; }
        .empty-text { color: var(--text-dim); }
        
        .hidden { display: none !important; }
        
        .debug-panel { background: var(--bg-input); border-radius: 8px; padding: 0.75rem; margin-top: 1rem; font-family: monospace; font-size: 0.7rem; color: var(--text-dim); max-height: 100px; overflow-y: auto; }
        
        @media (max-width: 900px) {
            .controls-grid { grid-template-columns: 1fr; }
            .chart-container { height: 320px; }
        }
        @media (max-width: 600px) {
            .indicator-btns { flex-direction: column; }
            .indicator-btn { justify-content: center; }
        }
    </style>
</head>
<body>

<!-- PAGE LOGIN -->
<div class="page active" id="pageLogin">
    <div class="login-box">
        <div class="login-header">
            <div class="login-icon">üêî</div>
            <div class="login-title">Production Avicole</div>
            <div class="login-subtitle">Tableau de bord v11</div>
        </div>
        <div class="card">
            <div class="alert" id="loginAlert"></div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="text" class="form-input" id="loginUser" placeholder="email@exemple.com" autocomplete="username">
            </div>
            <div class="form-group">
                <label class="form-label">Mot de passe</label>
                <input type="password" class="form-input" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
            </div>
            <button class="btn btn-primary" id="loginBtn">Se connecter</button>
            <div class="status-box" id="dbStatus"><span id="dbStatusText">Chargement...</span></div>
        </div>
    </div>
</div>

<!-- PAGE CONFIG ADMIN -->
<div class="page" id="pageConfig">
    <div class="config-box">
        <div class="login-header">
            <div class="login-icon">‚öôÔ∏è</div>
            <div class="login-title">Configuration Admin</div>
        </div>
        <div class="card">
            <div class="alert" id="configAlert"></div>
            
            <div class="config-section">
                <div class="config-title">üîå Connexion Supabase</div>
                <div class="form-group">
                    <label class="form-label">URL du projet</label>
                    <input type="url" class="form-input" id="cfgUrl" placeholder="https://xxx.supabase.co">
                </div>
                <div class="form-group">
                    <label class="form-label">Cl√© Anon (publique)</label>
                    <input type="text" class="form-input" id="cfgKey" placeholder="eyJhbG...">
                </div>
                <div class="btn-row">
                    <button class="btn btn-secondary" id="btnTestSupa">üîç Tester</button>
                    <button class="btn btn-primary" id="btnSaveSupa">üíæ Sauvegarder en base</button>
                </div>
                <p class="config-note">‚ö†Ô∏è La configuration sera stock√©e dans la table api_config de Supabase et partag√©e avec tous les utilisateurs.</p>
            </div>
            
            <button class="btn btn-primary" id="btnGoApp" style="margin-top:1rem;">‚û°Ô∏è Acc√©der √† l'application</button>
            <span class="back-link" id="btnBackLogin">‚Üê Retour connexion</span>
        </div>
    </div>
</div>

<!-- SESSION BAR -->
<div class="session-bar" id="sessionBar">
    <span class="session-user" id="sessionUser">üë§ Utilisateur</span>
    <span class="session-role" id="sessionRole">ROLE</span>
    <button class="session-btn hidden" id="btnConfig">‚öôÔ∏è Config</button>
    <button class="session-btn" id="btnLogout">D√©connexion</button>
</div>

<!-- PAGE APP -->
<div class="page page-app" id="pageApp">
    <div class="container">
        
        <header class="app-header">
            <div class="app-logo">
                <span class="logo-icon">üêî</span>
                <div>
                    <div class="app-title">Tableau de Bord Avicole</div>
                    <div class="app-subtitle">Analyse multi-indicateurs v11</div>
                </div>
            </div>
        </header>
        
        <!-- Banni√®re √©leveur (visible seulement pour role=eleveur) -->
        <div class="eleveur-banner hidden" id="eleveurBanner">
            <div class="eleveur-banner-icon">üë®‚Äçüåæ</div>
            <div class="eleveur-banner-info">
                <div class="eleveur-banner-label">Votre exploitation</div>
                <div class="eleveur-banner-name" id="eleveurBannerName">--</div>
                <div class="eleveur-banner-detail" id="eleveurBannerDetail">--</div>
            </div>
        </div>
        
        <!-- S√©lecteurs -->
        <div class="selectors-card" id="selectorsCard">
            <div class="selectors-grid">
                <div class="selector-group" id="selectorEleveurGroup">
                    <label>√âleveur</label>
                    <select class="selector-select" id="selEleveur"><option value="">-- S√©lectionner --</option></select>
                </div>
                <div class="selector-group">
                    <label>Site</label>
                    <select class="selector-select" id="selSite" disabled><option value="">-- S√©lectionner --</option></select>
                </div>
                <div class="selector-group">
                    <label>B√¢timent</label>
                    <select class="selector-select" id="selBatiment" disabled><option value="">-- S√©lectionner --</option></select>
                </div>
                <div class="selector-group">
                    <label>Lot</label>
                    <select class="selector-select" id="selLot" disabled><option value="">-- S√©lectionner --</option></select>
                </div>
            </div>
        </div>
        
        <!-- Info lot -->
        <div class="lot-card hidden" id="lotCard">
            <div class="lot-title">üê• Lot s√©lectionn√©</div>
            <div class="lot-grid">
                <div class="lot-item"><div class="lot-label">Code</div><div class="lot-value" id="lotCode">--</div></div>
                <div class="lot-item"><div class="lot-label">Souche</div><div class="lot-value" id="lotSouche">--</div></div>
                <div class="lot-item"><div class="lot-label">Effectif</div><div class="lot-value highlight" id="lotEffectif">--</div></div>
                <div class="lot-item"><div class="lot-label">Mise en place</div><div class="lot-value" id="lotDate">--</div></div>
                <div class="lot-item"><div class="lot-label">√Çge</div><div class="lot-value highlight" id="lotAge">--</div></div>
                <div class="lot-item"><div class="lot-label">Statut</div><div class="lot-value" id="lotStatut">--</div></div>
            </div>
        </div>
        
        <!-- CONTR√îLES -->
        <div class="controls-grid hidden" id="controlsGrid">
            <div class="control-card">
                <div class="control-title">Type de donn√©es <span class="control-hint">(s√©lectionnez 1 ou 2 indicateurs)</span></div>
                <div class="indicator-btns" id="indicatorBtns">
                    <button class="indicator-btn selected-y1" data-type="poids">
                        <span class="icon">üìà</span>Croissance en poids<span class="axis-tag">Y1</span>
                    </button>
                    <button class="indicator-btn" data-type="mortalite">
                        <span class="icon">‚ö†Ô∏è</span>Mortalit√©<span class="axis-tag"></span>
                    </button>
                    <button class="indicator-btn" data-type="aliment">
                        <span class="icon">üåæ</span>Consommation aliment<span class="axis-tag"></span>
                    </button>
                    <button class="indicator-btn" data-type="oeufs">
                        <span class="icon">ü•ö</span>Nombre ≈ìufs pondus<span class="axis-tag"></span>
                    </button>
                </div>
            </div>
            <div class="control-card">
                <div class="control-title">P√©riode d'analyse</div>
                <div class="period-btns" id="periodBtns">
                    <button class="period-btn" data-period="7">1 sem.</button>
                    <button class="period-btn" data-period="28">4 sem.</button>
                    <button class="period-btn active" data-period="56">8 sem.</button>
                    <button class="period-btn" data-period="all">Cycle complet</button>
                </div>
            </div>
        </div>
        
        <!-- GRAPHIQUE -->
        <div class="chart-card hidden" id="chartCard">
            <div class="chart-header">
                <div>
                    <div class="chart-title" id="chartTitle">√âvolution</div>
                    <div class="chart-subtitle" id="chartSubtitle">--</div>
                </div>
                <div class="chart-legend" id="chartLegend"></div>
            </div>
            <div class="chart-container">
                <canvas id="mainChart"></canvas>
            </div>
        </div>
        
        <!-- Stats -->
        <div class="stats-row hidden" id="statsRow">
            <div class="stat-card" id="statCard1">
                <div class="stat-header">
                    <span class="stat-title" id="statTitle1">--</span>
                    <span class="stat-icon" id="statIcon1">üìà</span>
                </div>
                <div class="stat-value"><span id="statValue1">--</span><span class="stat-unit" id="statUnit1"></span></div>
                <div class="stat-detail" id="statDetail1">--</div>
            </div>
            <div class="stat-card hidden" id="statCard2">
                <div class="stat-header">
                    <span class="stat-title" id="statTitle2">--</span>
                    <span class="stat-icon" id="statIcon2">‚ö†Ô∏è</span>
                </div>
                <div class="stat-value"><span id="statValue2">--</span><span class="stat-unit" id="statUnit2"></span></div>
                <div class="stat-detail" id="statDetail2">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Points de donn√©es</span>
                    <span class="stat-icon">üìä</span>
                </div>
                <div class="stat-value"><span id="dataCount">0</span></div>
                <div class="stat-detail" id="dataPeriod">--</div>
            </div>
        </div>
        
        <!-- Empty state -->
        <div class="chart-card" id="emptyState">
            <div class="empty-state">
                <div class="empty-icon">üìä</div>
                <div class="empty-title">S√©lectionnez un lot</div>
                <div class="empty-text">Choisissez un site, b√¢timent puis un lot pour afficher les graphiques</div>
            </div>
        </div>
        
        <div class="debug-panel">Debug: <span id="debugLog">Pr√™t</span></div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // ===================== CONFIGURATION =====================
    var ADMIN_LOCAL = { user: 'admin', pass: 'admin2024!' };
    
    // Variables globales
    var supabase = null;
    var currentUser = null;
    var currentEleveur = null; // Objet √©leveur complet pour le role=eleveur
    var mainChart = null;
    
    var lotData = { poids: [], mortalite: [], aliment: [], oeufs: [] };
    var standardsData = { poids: [], mortalite: [], aliment: [], oeufs: [] };
    
    var selectedIndicators = ['poids'];
    var currentPeriod = '56';
    var currentLotInfo = null;
    
    // Configuration des indicateurs avec couleurs pour zones
    var INDICATORS = {
        poids: {
            label: 'Croissance en poids',
            unit: 'g',
            color: '#22c55e',
            colorArea: 'rgba(34,197,94,0.25)',
            colorBorder: 'rgba(34,197,94,0.5)',
            icon: 'üìà',
            dataField: 'poids_moyen',
            stdMinField: 'poids_min',
            stdMaxField: 'poids_max'
        },
        mortalite: {
            label: 'Mortalit√©',
            unit: 'morts',
            color: '#f97316',
            colorArea: 'rgba(249,115,22,0.25)',
            colorBorder: 'rgba(249,115,22,0.5)',
            icon: '‚ö†Ô∏è',
            dataField: 'nombre_morts',
            stdMinField: 'mortalite_min',
            stdMaxField: 'mortalite_max'
        },
        aliment: {
            label: 'Consommation aliment',
            unit: 'g/j',
            color: '#3b82f6',
            colorArea: 'rgba(59,130,246,0.25)',
            colorBorder: 'rgba(59,130,246,0.5)',
            icon: 'üåæ',
            dataField: 'conso_par_animal',
            stdMinField: 'conso_min',
            stdMaxField: 'conso_max'
        },
        oeufs: {
            label: 'Nombre ≈ìufs pondus',
            unit: '≈ìufs',
            color: '#a855f7',
            colorArea: 'rgba(168,85,247,0.25)',
            colorBorder: 'rgba(168,85,247,0.5)',
            icon: 'ü•ö',
            dataField: 'nombre_oeufs',
            stdMinField: 'taux_ponte_min',
            stdMaxField: 'taux_ponte_max'
        }
    };
    
    // ===================== HELPERS =====================
    function $(id) { return document.getElementById(id); }
    function log(msg) { 
        console.log('[APP]', msg); 
        var el = $('debugLog'); 
        if (el) el.textContent = new Date().toLocaleTimeString() + ' - ' + msg; 
    }
    function showPage(id) { 
        document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); }); 
        $(id).classList.add('active'); 
    }
    function showAlert(id, type, msg) { 
        var el = $(id); 
        if (el) { el.className = 'alert alert-' + type + ' show'; el.innerHTML = msg; } 
    }
    function hideAlert(id) { 
        var el = $(id); 
        if (el) el.classList.remove('show'); 
    }
    
    // ===================== CONFIG SUPABASE =====================
    // Stockage local temporaire (utilis√© avant connexion √† la base)
    function getLocalConfig() {
        try { return JSON.parse(localStorage.getItem('avicole_supabase_cfg') || '{}'); } 
        catch (e) { return {}; }
    }
    function setLocalConfig(url, key) {
        localStorage.setItem('avicole_supabase_cfg', JSON.stringify({ url: url, key: key }));
    }
    
    // Initialiser Supabase avec config locale
    function initSupabaseFromLocal() {
        var cfg = getLocalConfig();
        if (!cfg.url || !cfg.key) {
            $('dbStatus').className = 'status-box warn';
            $('dbStatusText').textContent = 'Non configur√© - Admin requis';
            return false;
        }
        try {
            supabase = window.supabase.createClient(cfg.url, cfg.key);
            $('dbStatus').className = 'status-box ok';
            $('dbStatusText').textContent = 'Connect√© ‚úì';
            log('Supabase initialis√©');
            return true;
        } catch (e) {
            log('Erreur init Supabase: ' + e.message);
            $('dbStatus').className = 'status-box warn';
            $('dbStatusText').textContent = 'Erreur connexion';
            return false;
        }
    }
    
    // Sauvegarder config dans api_config (pour tous les utilisateurs)
    function saveConfigToDatabase(url, key) {
        if (!supabase) {
            showAlert('configAlert', 'error', '‚ùå Connexion non √©tablie');
            return;
        }
        
        showAlert('configAlert', 'info', '‚è≥ Sauvegarde en cours...');
        
        // V√©rifier si une config existe d√©j√†
        supabase.from('api_config').select('*').eq('service_name', 'supabase_app').single()
            .then(function(res) {
                var data = {
                    service_name: 'supabase_app',
                    api_url: url,
                    api_key: key,
                    is_active: true,
                    updated_at: new Date().toISOString()
                };
                
                if (res.data) {
                    // Update
                    return supabase.from('api_config').update(data).eq('id', res.data.id);
                } else {
                    // Insert
                    return supabase.from('api_config').insert(data);
                }
            })
            .then(function(res) {
                if (res.error) throw res.error;
                showAlert('configAlert', 'success', '‚úÖ Configuration sauvegard√©e en base !');
                setLocalConfig(url, key);
            })
            .catch(function(err) {
                showAlert('configAlert', 'error', '‚ùå Erreur: ' + err.message);
            });
    }
    
    // Charger config depuis api_config
    function loadConfigFromDatabase() {
        var cfg = getLocalConfig();
        if (!cfg.url || !cfg.key) {
            log('Pas de config locale');
            return Promise.resolve(false);
        }
        
        try {
            var tempClient = window.supabase.createClient(cfg.url, cfg.key);
            return tempClient.from('api_config').select('*').eq('service_name', 'supabase_app').eq('is_active', true).single()
                .then(function(res) {
                    if (res.data && res.data.api_url && res.data.api_key) {
                        setLocalConfig(res.data.api_url, res.data.api_key);
                        log('Config charg√©e depuis base');
                        return true;
                    }
                    return false;
                })
                .catch(function() { return false; });
        } catch (e) {
            return Promise.resolve(false);
        }
    }
    
    function testSupabaseConnection() {
        var url = $('cfgUrl').value.trim();
        var key = $('cfgKey').value.trim();
        
        if (!url || !key) {
            showAlert('configAlert', 'error', '‚ùå Remplissez URL et Cl√©');
            return;
        }
        
        showAlert('configAlert', 'info', '‚è≥ Test de connexion...');
        
        try {
            var testClient = window.supabase.createClient(url, key);
            testClient.from('users').select('id').limit(1)
                .then(function(res) {
                    if (res.error) {
                        showAlert('configAlert', 'error', '‚ùå Erreur: ' + res.error.message);
                    } else {
                        showAlert('configAlert', 'success', '‚úÖ Connexion r√©ussie !');
                        // Sauvegarder en local temporairement pour pouvoir sauver en base
                        setLocalConfig(url, key);
                        supabase = testClient;
                    }
                });
        } catch (e) {
            showAlert('configAlert', 'error', '‚ùå Erreur: ' + e.message);
        }
    }
    
    function saveSupabaseConfig() {
        var url = $('cfgUrl').value.trim();
        var key = $('cfgKey').value.trim();
        
        if (!url || !key) {
            showAlert('configAlert', 'error', '‚ùå Remplissez URL et Cl√©');
            return;
        }
        
        // D'abord s'assurer que la connexion fonctionne
        setLocalConfig(url, key);
        if (initSupabaseFromLocal()) {
            saveConfigToDatabase(url, key);
        } else {
            showAlert('configAlert', 'error', '‚ùå Impossible de se connecter');
        }
    }
    
    // ===================== AUTHENTIFICATION =====================
    function doLogin() {
        var user = $('loginUser').value.trim();
        var pass = $('loginPass').value;
        
        hideAlert('loginAlert');
        
        if (!user || !pass) {
            showAlert('loginAlert', 'error', '‚ùå Remplissez tous les champs');
            return;
        }
        
        // Admin local (pour config initiale)
        if (user === ADMIN_LOCAL.user && pass === ADMIN_LOCAL.pass) {
            currentUser = { nom: 'Administrateur', prenom: '', role: 'admin', email: 'admin' };
            currentEleveur = null;
            setupSessionBar('admin');
            
            // Charger config si existe
            var cfg = getLocalConfig();
            if (cfg.url) $('cfgUrl').value = cfg.url;
            if (cfg.key) $('cfgKey').value = cfg.key;
            
            showPage('pageConfig');
            return;
        }
        
        // Connexion normale via Supabase
        if (!supabase) {
            showAlert('loginAlert', 'error', '‚ùå Base non configur√©e.<br>Connectez-vous en admin: <b>admin / admin2024!</b>');
            return;
        }
        
        var btn = $('loginBtn');
        btn.disabled = true;
        btn.textContent = 'Connexion...';
        
        supabase.from('users').select('*').eq('email', user).eq('is_active', true).single()
            .then(function(res) {
                if (res.error || !res.data) {
                    throw new Error('Utilisateur non trouv√© ou inactif');
                }
                
                // V√©rifier mot de passe
                var storedPass = res.data.password_hash || '';
                if (storedPass !== pass && storedPass !== ('hash_' + pass)) {
                    throw new Error('Mot de passe incorrect');
                }
                
                currentUser = res.data;
                var role = res.data.role || 'eleveur';
                
                setupSessionBar(role);
                
                // Si c'est un √©leveur, trouver son √©leveur associ√©
                log('R√¥le d√©tect√©: ' + role + ' | User ID: ' + res.data.id);
                if (role === 'eleveur') {
                    return findEleveurForUser(res.data).then(function(eleveur) {
                        log('R√©sultat findEleveurForUser: ' + (eleveur ? 'TROUV√â ' + eleveur.nom : 'NULL'));
                        if (!eleveur) {
                            // Pas d'√©leveur trouv√© - afficher un message mais permettre l'acc√®s
                            log('ATTENTION: Aucun √©leveur associ√© √† ' + res.data.email);
                            showAlert('loginAlert', 'error', '‚ö†Ô∏è Aucun √©leveur associ√© √† ce compte. Contactez l\'administrateur.');
                            // On affiche quand m√™me l'app en mode "vide"
                            $('eleveurBanner').classList.remove('hidden');
                            $('eleveurBannerName').textContent = res.data.prenom + ' ' + res.data.nom;
                            $('eleveurBannerDetail').textContent = '‚ö†Ô∏è Compte non li√© √† un √©leveur';
                            $('selectorEleveurGroup').classList.add('hidden');
                            showPage('pageApp');
                            return;
                        }
                        currentEleveur = eleveur;
                        setupEleveurMode(eleveur);
                        showPage('pageApp');
                    });
                } else {
                    // Admin ou technicien
                    currentEleveur = null;
                    setupAdminMode();
                    showPage('pageApp');
                }
            })
            .catch(function(err) {
                showAlert('loginAlert', 'error', '‚ùå ' + err.message);
            })
            .finally(function() {
                btn.disabled = false;
                btn.textContent = 'Se connecter';
            });
    }
    
    function findEleveurForUser(user) {
        log('Recherche √©leveur pour user: ' + user.email + ' (id: ' + user.id + ')');
        
        // M√©thode 1: Chercher par user_id dans eleveurs
        return supabase.from('eleveurs').select('*').eq('user_id', user.id).eq('is_active', true).maybeSingle()
            .then(function(res1) {
                if (res1.data) {
                    log('√âleveur trouv√© par user_id: ' + res1.data.nom);
                    return res1.data;
                }
                
                // M√©thode 2: Chercher par email dans eleveurs
                log('Pas trouv√© par user_id, recherche par email: ' + user.email);
                return supabase.from('eleveurs').select('*').eq('email', user.email).eq('is_active', true).maybeSingle()
                    .then(function(res2) {
                        if (res2.data) {
                            log('√âleveur trouv√© par email: ' + res2.data.nom);
                            return res2.data;
                        }
                        
                        log('Aucun √©leveur trouv√© pour ' + user.email);
                        return null;
                    });
            })
            .catch(function(err) {
                log('Erreur recherche √©leveur: ' + err.message);
                return null;
            });
    }
    
    function setupSessionBar(role) {
        var name = currentUser.prenom ? (currentUser.prenom + ' ' + currentUser.nom) : currentUser.nom;
        $('sessionUser').textContent = 'üë§ ' + name;
        $('sessionRole').textContent = role.toUpperCase();
        $('sessionRole').className = 'session-role ' + role;
        
        if (role === 'admin' || role === 'technicien') {
            $('btnConfig').classList.remove('hidden');
        } else {
            $('btnConfig').classList.add('hidden');
        }
        
        $('sessionBar').style.display = 'flex';
    }
    
    function setupEleveurMode(eleveur) {
        log('Mode √©leveur: ' + eleveur.nom);
        
        // Masquer s√©lecteur √©leveur
        $('selectorEleveurGroup').classList.add('hidden');
        
        // Afficher banni√®re √©leveur
        $('eleveurBanner').classList.remove('hidden');
        $('eleveurBannerName').textContent = eleveur.nom + ' ' + (eleveur.prenom || '');
        $('eleveurBannerDetail').textContent = 'Code: ' + eleveur.code_eleveur + 
            (eleveur.raison_sociale ? ' | ' + eleveur.raison_sociale : '');
        
        // Charger les sites de cet √©leveur
        loadSitesForEleveur(eleveur.id);
    }
    
    function setupAdminMode() {
        log('Mode admin/technicien');
        
        // Afficher s√©lecteur √©leveur
        $('selectorEleveurGroup').classList.remove('hidden');
        
        // Masquer banni√®re √©leveur
        $('eleveurBanner').classList.add('hidden');
        
        // Charger tous les √©leveurs
        loadAllEleveurs();
    }
    
    function doLogout() {
        currentUser = null;
        currentEleveur = null;
        $('sessionBar').style.display = 'none';
        $('loginUser').value = '';
        $('loginPass').value = '';
        hideAlert('loginAlert');
        resetAllSelectors();
        hideDataPanels();
        showPage('pageLogin');
    }
    
    // ===================== CHARGEMENT DONN√âES =====================
    function loadAllEleveurs() {
        if (!supabase) return;
        log('Chargement tous √©leveurs...');
        
        supabase.from('eleveurs').select('*').eq('is_active', true).order('nom')
            .then(function(res) {
                var sel = $('selEleveur');
                sel.innerHTML = '<option value="">-- S√©lectionner un √©leveur --</option>';
                (res.data || []).forEach(function(e) {
                    var opt = document.createElement('option');
                    opt.value = e.id;
                    opt.setAttribute('data-json', JSON.stringify(e));
                    opt.textContent = e.nom + ' ' + (e.prenom || '') + ' (' + e.code_eleveur + ')';
                    sel.appendChild(opt);
                });
                log('√âleveurs charg√©s: ' + (res.data || []).length);
            });
    }
    
    function loadSitesForEleveur(eleveurId) {
        if (!supabase || !eleveurId) return;
        log('Chargement sites √©leveur: ' + eleveurId);
        
        supabase.from('sites').select('*').eq('eleveur_id', eleveurId).eq('is_active', true).order('nom')
            .then(function(res) {
                var sel = $('selSite');
                sel.innerHTML = '<option value="">-- S√©lectionner un site --</option>';
                sel.disabled = false;
                
                var sites = res.data || [];
                sites.forEach(function(s) {
                    var opt = document.createElement('option');
                    opt.value = s.id;
                    opt.setAttribute('data-json', JSON.stringify(s));
                    opt.textContent = s.nom + (s.ville ? ' (' + s.ville + ')' : '');
                    sel.appendChild(opt);
                });
                
                log('Sites charg√©s: ' + sites.length);
                
                // Auto-s√©lection si un seul site
                if (sites.length === 1) {
                    sel.value = sites[0].id;
                    onSiteChange();
                }
            });
    }
    
    function onEleveurChange() {
        var id = $('selEleveur').value;
        resetSelectors('site');
        if (!id) return;
        loadSitesForEleveur(id);
    }
    
    function onSiteChange() {
        var id = $('selSite').value;
        resetSelectors('batiment');
        if (!id) return;
        
        supabase.from('batiments').select('*').eq('site_id', id).eq('is_active', true).order('nom')
            .then(function(res) {
                var sel = $('selBatiment');
                sel.innerHTML = '<option value="">-- S√©lectionner --</option>';
                sel.disabled = false;
                
                var bats = res.data || [];
                bats.forEach(function(b) {
                    var opt = document.createElement('option');
                    opt.value = b.id;
                    opt.textContent = b.nom + (b.capacite ? ' (cap. ' + b.capacite + ')' : '');
                    sel.appendChild(opt);
                });
                
                log('B√¢timents charg√©s: ' + bats.length);
                
                if (bats.length === 1) {
                    sel.value = bats[0].id;
                    onBatimentChange();
                }
            });
    }
    
    function onBatimentChange() {
        var id = $('selBatiment').value;
        resetSelectors('lot');
        if (!id) return;
        
        supabase.from('lots').select('*, souches(nom)').eq('batiment_id', id).order('date_mise_place', { ascending: false })
            .then(function(res) {
                var sel = $('selLot');
                sel.innerHTML = '<option value="">-- S√©lectionner --</option>';
                sel.disabled = false;
                
                var lots = res.data || [];
                lots.forEach(function(l) {
                    var opt = document.createElement('option');
                    opt.value = l.id;
                    opt.setAttribute('data-json', JSON.stringify(l));
                    var icon = l.statut === 'actif' ? 'üü¢' : '‚ö™';
                    var souche = l.souches ? l.souches.nom : 'N/A';
                    opt.textContent = icon + ' ' + l.code_lot + ' - ' + souche;
                    sel.appendChild(opt);
                });
                
                log('Lots charg√©s: ' + lots.length);
                
                // Auto-s√©lection du lot actif
                var actif = lots.find(function(l) { return l.statut === 'actif'; });
                if (actif) {
                    sel.value = actif.id;
                    onLotChange();
                }
            });
    }
    
    function onLotChange() {
        var id = $('selLot').value;
        if (!id) { hideDataPanels(); return; }
        
        var opt = document.querySelector('#selLot option[value="' + id + '"]');
        var lot = {};
        try { lot = JSON.parse(opt.getAttribute('data-json') || '{}'); } catch (e) {}
        currentLotInfo = lot;
        
        // Afficher infos lot
        $('lotCode').textContent = lot.code_lot || '--';
        $('lotSouche').textContent = (lot.souches && lot.souches.nom) ? lot.souches.nom : '--';
        $('lotEffectif').textContent = lot.effectif_depart ? lot.effectif_depart.toLocaleString('fr-FR') : '--';
        $('lotDate').textContent = lot.date_mise_place ? new Date(lot.date_mise_place).toLocaleDateString('fr-FR') : '--';
        $('lotAge').textContent = lot.date_mise_place ? Math.floor((Date.now() - new Date(lot.date_mise_place)) / 86400000) + ' jours' : '--';
        $('lotStatut').textContent = lot.statut || '--';
        
        log('Chargement donn√©es lot: ' + lot.code_lot);
        
        // Charger les donn√©es
        Promise.all([
            supabase.from('donnees_poids').select('*').eq('lot_id', id).order('jour_age'),
            supabase.from('donnees_mortalite').select('*').eq('lot_id', id).order('jour_age'),
            supabase.from('donnees_aliment').select('*').eq('lot_id', id).order('jour_age'),
            supabase.from('donnees_oeufs').select('*').eq('lot_id', id).order('jour_age')
        ]).then(function(results) {
            lotData.poids = results[0].data || [];
            lotData.mortalite = results[1].data || [];
            lotData.aliment = results[2].data || [];
            lotData.oeufs = results[3].data || [];
            
            log('Donn√©es: P=' + lotData.poids.length + ' M=' + lotData.mortalite.length + ' A=' + lotData.aliment.length + ' O=' + lotData.oeufs.length);
            
            if (lot.souche_id) {
                loadStandards(lot.souche_id);
            } else {
                showDataPanels();
                updateUI();
            }
        });
    }
    
    function loadStandards(soucheId) {
        log('Chargement standards souche: ' + soucheId);
        
        Promise.all([
            supabase.from('standards_poids').select('*').eq('souche_id', soucheId).order('jour_age'),
            supabase.from('standards_mortalite').select('*').eq('souche_id', soucheId).order('jour_age'),
            supabase.from('standards_aliment').select('*').eq('souche_id', soucheId).order('jour_age'),
            supabase.from('standards_oeufs').select('*').eq('souche_id', soucheId).order('jour_age')
        ]).then(function(results) {
            standardsData.poids = results[0].data || [];
            standardsData.mortalite = results[1].data || [];
            standardsData.aliment = results[2].data || [];
            standardsData.oeufs = results[3].data || [];
            
            log('Standards: P=' + standardsData.poids.length + ' M=' + standardsData.mortalite.length + ' A=' + standardsData.aliment.length + ' O=' + standardsData.oeufs.length);
            
            showDataPanels();
            updateUI();
        });
    }
    
    function resetSelectors(from) {
        var order = ['site', 'batiment', 'lot'];
        var start = order.indexOf(from);
        for (var i = start; i < order.length; i++) {
            var name = order[i].charAt(0).toUpperCase() + order[i].slice(1);
            var sel = $('sel' + name);
            sel.innerHTML = '<option value="">-- S√©lectionner --</option>';
            sel.disabled = true;
        }
        hideDataPanels();
    }
    
    function resetAllSelectors() {
        $('selEleveur').innerHTML = '<option value="">-- S√©lectionner --</option>';
        resetSelectors('site');
    }
    
    function showDataPanels() {
        $('lotCard').classList.remove('hidden');
        $('controlsGrid').classList.remove('hidden');
        $('chartCard').classList.remove('hidden');
        $('statsRow').classList.remove('hidden');
        $('emptyState').classList.add('hidden');
    }
    
    function hideDataPanels() {
        $('lotCard').classList.add('hidden');
        $('controlsGrid').classList.add('hidden');
        $('chartCard').classList.add('hidden');
        $('statsRow').classList.add('hidden');
        $('emptyState').classList.remove('hidden');
    }
    
    // ===================== UI UPDATE =====================
    function updateUI() {
        updateChart();
        updateStats();
        updateLegend();
    }
    
    function updateStats() {
        var type1 = selectedIndicators[0];
        var ind1 = INDICATORS[type1];
        var data1 = lotData[type1] || [];
        
        $('statTitle1').textContent = ind1.label;
        $('statIcon1').textContent = ind1.icon;
        $('statUnit1').textContent = ind1.unit;
        
        if (data1.length > 0) {
            var last1 = data1[data1.length - 1];
            var val1 = parseFloat(last1[ind1.dataField]) || 0;
            $('statValue1').textContent = Math.round(val1);
            $('statDetail1').textContent = 'Jour ' + last1.jour_age;
        } else {
            $('statValue1').textContent = '--';
            $('statDetail1').textContent = 'Pas de donn√©es';
        }
        
        // Stat 2
        if (selectedIndicators[1]) {
            var type2 = selectedIndicators[1];
            var ind2 = INDICATORS[type2];
            var data2 = lotData[type2] || [];
            
            $('statCard2').classList.remove('hidden');
            $('statTitle2').textContent = ind2.label;
            $('statIcon2').textContent = ind2.icon;
            $('statUnit2').textContent = ind2.unit;
            
            if (data2.length > 0) {
                var last2 = data2[data2.length - 1];
                var val2 = parseFloat(last2[ind2.dataField]) || 0;
                $('statValue2').textContent = Math.round(val2);
                $('statDetail2').textContent = 'Jour ' + last2.jour_age;
            } else {
                $('statValue2').textContent = '--';
                $('statDetail2').textContent = 'Pas de donn√©es';
            }
        } else {
            $('statCard2').classList.add('hidden');
        }
        
        // Total points
        var total = 0;
        selectedIndicators.forEach(function(t) { total += (lotData[t] || []).length; });
        $('dataCount').textContent = total;
        $('dataPeriod').textContent = currentPeriod === 'all' ? 'Cycle complet' : currentPeriod + ' jours';
    }
    
    function updateLegend() {
        var html = '';
        selectedIndicators.forEach(function(type, idx) {
            var ind = INDICATORS[type];
            var axisLabel = idx === 0 ? '(Y1)' : '(Y2)';
            html += '<div class="legend-item"><span class="legend-line" style="background:' + ind.color + '"></span>' + ind.label + ' ' + axisLabel + '</div>';
            html += '<div class="legend-item"><span class="legend-area" style="background:' + ind.colorArea + '"></span>Zone tol√©rance ' + axisLabel + '</div>';
        });
        $('chartLegend').innerHTML = html;
    }
    
    function updateChart() {
        var canvas = $('mainChart');
        if (!canvas) return;
        var ctx = canvas.getContext('2d');
        if (mainChart) { mainChart.destroy(); mainChart = null; }
        
        var type1 = selectedIndicators[0];
        var type2 = selectedIndicators[1];
        var ind1 = INDICATORS[type1];
        var data1 = filterByPeriod(lotData[type1] || []);
        var std1 = standardsData[type1] || [];
        
        if (data1.length === 0) {
            $('chartTitle').textContent = 'Aucune donn√©e disponible';
            $('chartSubtitle').textContent = 'S√©lectionnez un autre type ou lot';
            return;
        }
        
        // Labels et jours
        var labels = data1.map(function(d) { return 'J' + d.jour_age; });
        var jourAges = data1.map(function(d) { return d.jour_age; });
        
        // Titre
        var title = ind1.label;
        if (type2) title += ' vs ' + INDICATORS[type2].label;
        $('chartTitle').textContent = title;
        $('chartSubtitle').textContent = type2 ? 'Comparaison sur deux axes' : '√âvolution temporelle';
        
        var datasets = [];
        
        // ========== Y1: Zone de tol√©rance ==========
        var stdMin1 = [], stdMax1 = [];
        jourAges.forEach(function(ja) {
            var s = std1.find(function(x) { return x.jour_age === ja; });
            stdMin1.push(s ? (parseFloat(s[ind1.stdMinField]) || null) : null);
            stdMax1.push(s ? (parseFloat(s[ind1.stdMaxField]) || null) : null);
        });
        
        var hasZone1 = stdMax1.some(function(v) { return v !== null; });
        if (hasZone1) {
            // Zone remplie entre min et max
            datasets.push({
                label: '_zone1_max',
                data: stdMax1,
                borderColor: 'transparent',
                backgroundColor: ind1.colorArea,
                fill: '+1',
                pointRadius: 0,
                yAxisID: 'y1',
                order: 100
            });
            datasets.push({
                label: '_zone1_min',
                data: stdMin1,
                borderColor: ind1.colorBorder,
                borderWidth: 1,
                borderDash: [5, 5],
                backgroundColor: 'transparent',
                fill: false,
                pointRadius: 0,
                yAxisID: 'y1',
                order: 99
            });
            datasets.push({
                label: '_zone1_max_line',
                data: stdMax1,
                borderColor: ind1.colorBorder,
                borderWidth: 1,
                borderDash: [5, 5],
                backgroundColor: 'transparent',
                fill: false,
                pointRadius: 0,
                yAxisID: 'y1',
                order: 99
            });
        }
        
        // Y1: Courbe principale
        var values1 = data1.map(function(d) { return parseFloat(d[ind1.dataField]) || 0; });
        datasets.push({
            label: ind1.label,
            data: values1,
            borderColor: ind1.color,
            backgroundColor: ind1.color,
            borderWidth: 3,
            tension: 0.35,
            fill: false,
            pointRadius: values1.length > 50 ? 0 : 4,
            pointBackgroundColor: ind1.color,
            yAxisID: 'y1',
            order: 1
        });
        
        // Scales
        var scales = {
            x: {
                grid: { color: 'rgba(71,85,105,0.3)' },
                ticks: { color: '#94a3b8', maxTicksLimit: 15 },
                title: { display: true, text: 'Jours du cycle', color: '#64748b' }
            },
            y1: {
                type: 'linear',
                position: 'left',
                grid: { color: 'rgba(71,85,105,0.3)' },
                ticks: { color: ind1.color },
                title: { display: true, text: ind1.label + ' (' + ind1.unit + ')', color: ind1.color }
            }
        };
        
        // ========== Y2: Zone de tol√©rance et courbe ==========
        if (type2) {
            var ind2 = INDICATORS[type2];
            var data2 = filterByPeriod(lotData[type2] || []);
            var std2 = standardsData[type2] || [];
            
            // Zone Y2
            var stdMin2 = [], stdMax2 = [];
            jourAges.forEach(function(ja) {
                var s = std2.find(function(x) { return x.jour_age === ja; });
                stdMin2.push(s ? (parseFloat(s[ind2.stdMinField]) || null) : null);
                stdMax2.push(s ? (parseFloat(s[ind2.stdMaxField]) || null) : null);
            });
            
            var hasZone2 = stdMax2.some(function(v) { return v !== null; });
            if (hasZone2) {
                datasets.push({
                    label: '_zone2_max',
                    data: stdMax2,
                    borderColor: 'transparent',
                    backgroundColor: ind2.colorArea,
                    fill: '+1',
                    pointRadius: 0,
                    yAxisID: 'y2',
                    order: 98
                });
                datasets.push({
                    label: '_zone2_min',
                    data: stdMin2,
                    borderColor: ind2.colorBorder,
                    borderWidth: 1,
                    borderDash: [5, 5],
                    backgroundColor: 'transparent',
                    fill: false,
                    pointRadius: 0,
                    yAxisID: 'y2',
                    order: 97
                });
                datasets.push({
                    label: '_zone2_max_line',
                    data: stdMax2,
                    borderColor: ind2.colorBorder,
                    borderWidth: 1,
                    borderDash: [5, 5],
                    backgroundColor: 'transparent',
                    fill: false,
                    pointRadius: 0,
                    yAxisID: 'y2',
                    order: 97
                });
            }
            
            // Courbe Y2
            var values2 = jourAges.map(function(ja) {
                var d = data2.find(function(x) { return x.jour_age === ja; });
                return d ? (parseFloat(d[ind2.dataField]) || 0) : null;
            });
            
            datasets.push({
                label: ind2.label,
                data: values2,
                borderColor: ind2.color,
                backgroundColor: ind2.color,
                borderWidth: 3,
                tension: 0.35,
                fill: false,
                pointRadius: values2.filter(function(v) { return v !== null; }).length > 50 ? 0 : 4,
                pointBackgroundColor: ind2.color,
                yAxisID: 'y2',
                order: 2
            });
            
            scales.y2 = {
                type: 'linear',
                position: 'right',
                grid: { drawOnChartArea: false },
                ticks: { color: ind2.color },
                title: { display: true, text: ind2.label + ' (' + ind2.unit + ')', color: ind2.color }
            };
        }
        
        // Cr√©er le graphique
        mainChart = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(15,23,42,0.95)',
                        titleColor: '#f8fafc',
                        bodyColor: '#94a3b8',
                        padding: 12,
                        displayColors: true,
                        filter: function(item) {
                            return !item.dataset.label.startsWith('_');
                        }
                    }
                },
                scales: scales
            }
        });
    }
    
    function filterByPeriod(data) {
        if (!data || !data.length || currentPeriod === 'all') return data;
        var days = parseInt(currentPeriod);
        return data.slice(-days);
    }
    
    // ===================== GESTION INDICATEURS =====================
    function onIndicatorClick(e) {
        var btn = e.currentTarget;
        var type = btn.getAttribute('data-type');
        var idx = selectedIndicators.indexOf(type);
        
        if (idx === 0) {
            // D√©j√† Y1: le retirer si Y2 existe
            if (selectedIndicators.length > 1) {
                selectedIndicators = [selectedIndicators[1]];
            }
        } else if (idx === 1) {
            // D√©j√† Y2: le retirer
            selectedIndicators = [selectedIndicators[0]];
        } else {
            // Pas s√©lectionn√©: l'ajouter
            if (selectedIndicators.length < 2) {
                selectedIndicators.push(type);
            } else {
                // Remplacer Y2
                selectedIndicators[1] = type;
            }
        }
        
        updateIndicatorButtons();
        updateUI();
    }
    
    function updateIndicatorButtons() {
        document.querySelectorAll('#indicatorBtns .indicator-btn').forEach(function(btn) {
            var type = btn.getAttribute('data-type');
            var tag = btn.querySelector('.axis-tag');
            
            btn.classList.remove('selected-y1', 'selected-y2');
            tag.textContent = '';
            
            if (selectedIndicators[0] === type) {
                btn.classList.add('selected-y1');
                tag.textContent = 'Y1';
            } else if (selectedIndicators[1] === type) {
                btn.classList.add('selected-y2');
                tag.textContent = 'Y2';
            }
        });
    }
    
    // ===================== INITIALISATION =====================
    document.addEventListener('DOMContentLoaded', function() {
        log('App v11 d√©marr√©e');
        
        // Essayer de charger la config
        loadConfigFromDatabase().then(function() {
            initSupabaseFromLocal();
        });
        
        // Events login
        $('loginBtn').addEventListener('click', doLogin);
        $('loginPass').addEventListener('keypress', function(e) { if (e.key === 'Enter') doLogin(); });
        
        // Events config
        $('btnTestSupa').addEventListener('click', testSupabaseConnection);
        $('btnSaveSupa').addEventListener('click', saveSupabaseConfig);
        $('btnBackLogin').addEventListener('click', function() { showPage('pageLogin'); });
        $('btnGoApp').addEventListener('click', function() {
            if (!supabase && !initSupabaseFromLocal()) {
                showAlert('configAlert', 'error', '‚ùå Configurez d\'abord Supabase');
                return;
            }
            setupAdminMode();
            showPage('pageApp');
        });
        
        // Events session
        $('btnLogout').addEventListener('click', doLogout);
        $('btnConfig').addEventListener('click', function() {
            var cfg = getLocalConfig();
            if (cfg.url) $('cfgUrl').value = cfg.url;
            if (cfg.key) $('cfgKey').value = cfg.key;
            showPage('pageConfig');
        });
        
        // Events s√©lecteurs
        $('selEleveur').addEventListener('change', onEleveurChange);
        $('selSite').addEventListener('change', onSiteChange);
        $('selBatiment').addEventListener('change', onBatimentChange);
        $('selLot').addEventListener('change', onLotChange);
        
        // Events indicateurs
        document.querySelectorAll('#indicatorBtns .indicator-btn').forEach(function(btn) {
            btn.addEventListener('click', onIndicatorClick);
        });
        
        // Events p√©riode
        document.querySelectorAll('#periodBtns .period-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#periodBtns .period-btn').forEach(function(b) { b.classList.remove('active'); });
                this.classList.add('active');
                currentPeriod = this.getAttribute('data-period');
                updateUI();
            });
        });
    });
})();
</script>
</body>
</html>
