<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Dataferme - Production Avicole</title>
    <link rel="icon" type="image/png" href="Logo_Dataferme.png">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Theme Dark (default) */
        :root, [data-theme="dark"] {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --green: #22c55e;
            --green-light: rgba(34,197,94,0.15);
            --green-area: rgba(34,197,94,0.3);
            --orange: #f97316;
            --orange-light: rgba(249,115,22,0.15);
            --orange-area: rgba(249,115,22,0.3);
            --blue: #3b82f6;
            --blue-light: rgba(59,130,246,0.15);
            --blue-area: rgba(59,130,246,0.3);
            --purple: #a855f7;
            --purple-light: rgba(168,85,247,0.15);
            --purple-area: rgba(168,85,247,0.3);
            --red: #ef4444;
            --red-light: rgba(239,68,68,0.15);
            --text: #f8fafc;
            --text-dim: #94a3b8;
            --border: #475569;
            --chart-grid: rgba(71,85,105,0.3);
            --chart-text: #94a3b8;
        }
        
        /* Theme Light */
        [data-theme="light"] {
            --bg-dark: #f1f5f9;
            --bg-card: #ffffff;
            --bg-input: #e2e8f0;
            --green: #16a34a;
            --green-light: rgba(22,163,74,0.12);
            --green-area: rgba(22,163,74,0.25);
            --orange: #ea580c;
            --orange-light: rgba(234,88,12,0.12);
            --orange-area: rgba(234,88,12,0.25);
            --blue: #2563eb;
            --blue-light: rgba(37,99,235,0.12);
            --blue-area: rgba(37,99,235,0.25);
            --purple: #9333ea;
            --purple-light: rgba(147,51,234,0.12);
            --purple-area: rgba(147,51,234,0.25);
            --red: #dc2626;
            --red-light: rgba(220,38,38,0.12);
            --text: #1e293b;
            --text-dim: #64748b;
            --border: #cbd5e1;
            --chart-grid: rgba(148,163,184,0.3);
            --chart-text: #64748b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text); min-height: 100vh; }
        
        .page { display: none; min-height: 100vh; }
        .page.active { display: flex; align-items: center; justify-content: center; }
        .page-app.active { display: block; }
        
        .login-box { width: 100%; max-width: 400px; padding: 2rem; }
        .login-header { text-align: center; margin-bottom: 2rem; }
        .login-icon { font-size: 4rem; margin-bottom: 1rem; }
        .login-title { font-size: 1.5rem; font-weight: 700; }
        .login-subtitle { color: var(--text-dim); margin-top: 0.5rem; }
        .card { background: var(--bg-card); border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border); }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-dim); margin-bottom: 0.4rem; text-transform: uppercase; }
        .form-input { width: 100%; padding: 0.8rem 1rem; background: var(--bg-input); border: 2px solid var(--border); border-radius: 10px; color: var(--text); font-size: 1rem; font-family: inherit; }
        .form-input:focus { outline: none; border-color: var(--blue); }
        .form-input:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn { padding: 0.8rem 1.5rem; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; }
        .btn-full { width: 100%; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.85rem; }
        .btn-primary { background: linear-gradient(135deg, var(--green), var(--blue)); color: white; }
        .btn-secondary { background: var(--bg-input); color: var(--text); border: 2px solid var(--border); }
        .btn-danger { background: var(--red); color: white; }
        .btn-warning { background: var(--orange); color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .alert { padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; display: none; font-size: 0.85rem; }
        .alert.show { display: block; }
        .alert-error { background: var(--red-light); border: 1px solid var(--red); color: var(--red); }
        .alert-success { background: var(--green-light); border: 1px solid var(--green); color: var(--green); }
        .alert-info { background: var(--blue-light); border: 1px solid var(--blue); color: var(--blue); }
        .status-box { text-align: center; margin-top: 1rem; padding: 0.7rem; background: var(--bg-input); border-radius: 8px; font-size: 0.85rem; }
        .status-box.ok { background: var(--green-light); color: var(--green); }
        .status-box.error { background: var(--red-light); color: var(--red); }
        
        /* Session bar */
        .session-bar { position: fixed; top: 1rem; right: 1rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 50px; padding: 0.5rem 1rem; display: none; align-items: center; gap: 0.75rem; font-size: 0.8rem; z-index: 1000; }
        .session-user { font-weight: 500; }
        .session-role { padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.7rem; font-weight: 700; }
        .session-role.eleveur { background: var(--green-light); color: var(--green); }
        .session-role.admin { background: var(--orange-light); color: var(--orange); }
        
        /* Theme toggle button */
        .theme-toggle { 
            background: var(--bg-input); 
            border: 1px solid var(--border); 
            border-radius: 50%; 
            width: 32px; 
            height: 32px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .theme-toggle:hover { background: var(--border); transform: rotate(20deg); }
        .session-role.technicien { background: var(--blue-light); color: var(--blue); }
        .session-btn { background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; padding: 0.3rem 0.6rem; color: var(--text-dim); font-size: 0.75rem; cursor: pointer; font-family: inherit; }
        .session-btn:hover { background: var(--border); }
        
        /* Admin Menu Bar */
        .admin-menu-bar { 
            background: linear-gradient(135deg, var(--orange-light), var(--purple-light)); 
            border-bottom: 2px solid var(--orange);
            padding: 0.75rem 1.5rem;
            display: none;
            align-items: center;
            gap: 1rem;
        }
        .admin-menu-bar.show { display: flex; }
        .admin-menu-label { font-size: 0.75rem; text-transform: uppercase; color: var(--orange); font-weight: 700; }
        .admin-menu-buttons { display: flex; gap: 0.5rem; flex: 1; }
        .admin-menu-btn {
            display: flex; align-items: center; gap: 0.4rem;
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.85rem;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }
        .admin-menu-btn:hover { background: var(--bg-input); border-color: var(--orange); }
        .admin-menu-btn.active { background: var(--orange); color: white; border-color: var(--orange); }
        .admin-menu-btn .menu-icon { font-size: 1rem; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
        
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        .app-logo { display: flex; align-items: center; gap: 1rem; }
        .logo-icon { font-size: 2.5rem; }
        .app-title { font-size: 1.4rem; font-weight: 700; }
        .app-subtitle { color: var(--text-dim); font-size: 0.85rem; }
        
        .eleveur-banner { background: linear-gradient(135deg, var(--green-light), var(--blue-light)); border: 2px solid var(--green); border-radius: 12px; padding: 1rem 1.5rem; margin-bottom: 1rem; display: none; align-items: center; gap: 1rem; }
        .eleveur-banner.show { display: flex; }
        .eleveur-banner-icon { font-size: 2.5rem; }
        .eleveur-banner-info { flex: 1; }
        .eleveur-banner-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-dim); }
        .eleveur-banner-name { font-size: 1.2rem; font-weight: 700; color: var(--green); }
        .eleveur-banner-detail { font-size: 0.85rem; color: var(--text-dim); }
        
        .selectors-card { background: var(--bg-card); border-radius: 12px; padding: 1rem; border: 1px solid var(--border); margin-bottom: 1rem; }
        .selectors-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .selector-group { display: block; }
        .selector-group.hidden { display: none; }
        .selector-group label { display: block; font-size: 0.7rem; text-transform: uppercase; color: var(--text-dim); margin-bottom: 0.3rem; font-weight: 600; }
        .selector-select { width: 100%; padding: 0.7rem 1rem; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.9rem; cursor: pointer; font-family: inherit; }
        .selector-select:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .lot-card { background: var(--bg-card); border-radius: 12px; padding: 1rem; border: 1px solid var(--border); margin-bottom: 1rem; display: none; }
        .lot-card.show { display: block; }
        .lot-title { font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem; }
        .lot-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.5rem; }
        .lot-item { background: var(--bg-input); padding: 0.6rem; border-radius: 8px; }
        .lot-label { font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; }
        .lot-value { font-size: 0.9rem; font-weight: 600; }
        .lot-value.highlight { color: var(--green); }
        
        .controls-grid { display: none; grid-template-columns: 1.5fr 1fr; gap: 1rem; margin-bottom: 1rem; }
        .controls-grid.show { display: grid; }
        .control-card { background: var(--bg-card); border-radius: 12px; padding: 1.25rem; border: 1px solid var(--border); }
        .control-title { font-size: 0.75rem; text-transform: uppercase; color: var(--text-dim); margin-bottom: 0.75rem; font-weight: 600; }
        .control-hint { font-weight: 400; font-style: italic; opacity: 0.7; }
        
        .indicator-btns { display: flex; flex-wrap: wrap; gap: 0.6rem; }
        .indicator-btn {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.7rem 1.1rem;
            border: 2px solid var(--border);
            background: transparent;
            border-radius: 30px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85rem;
            color: var(--text-dim);
            transition: all 0.2s ease;
        }
        .indicator-btn:hover { border-color: var(--text-dim); background: var(--bg-input); }
        .indicator-btn .icon { font-size: 1rem; }
        .indicator-btn .axis-tag { font-size: 0.6rem; font-weight: 700; padding: 0.15rem 0.4rem; border-radius: 4px; background: var(--bg-input); color: var(--text-dim); min-width: 24px; text-align: center; }
        .indicator-btn.selected-y1 { border-color: #2563eb; background: rgba(37,99,235,0.15); color: #2563eb; }
        .indicator-btn.selected-y1 .axis-tag { background: #2563eb; color: white; }
        .indicator-btn.selected-y2 { border-color: #e11d48; background: rgba(225,29,72,0.15); color: #e11d48; }
        .indicator-btn.selected-y2 .axis-tag { background: #e11d48; color: white; }
        
        .period-btns { display: flex; gap: 0.5rem; }
        .period-btn { flex: 1; padding: 0.7rem; border: 1px solid var(--border); background: transparent; border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 0.85rem; color: var(--text-dim); }
        .period-btn.active { background: var(--blue-light); border-color: var(--blue); color: var(--blue); font-weight: 600; }
        
        .chart-card { background: var(--bg-card); border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border); margin-bottom: 1rem; display: none; }
        .chart-card.show { display: block; }
        .chart-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
        .chart-title { font-size: 1.3rem; font-weight: 700; }
        .chart-subtitle { color: var(--text-dim); font-size: 0.9rem; margin-top: 0.25rem; }
        .chart-legend { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
        .legend-item { display: flex; align-items: center; gap: 0.4rem; font-size: 0.8rem; color: var(--text-dim); }
        .legend-line { width: 24px; height: 3px; border-radius: 2px; }
        .legend-area { width: 24px; height: 14px; border-radius: 3px; }
        .chart-container { height: 420px; position: relative; }
        
        .stats-row { display: none; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .stats-row.show { display: grid; }
        .stat-card { background: var(--bg-card); border-radius: 12px; padding: 1rem; border: 1px solid var(--border); }
        .stat-card.hidden { display: none; }
        .stat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .stat-title { font-size: 0.7rem; text-transform: uppercase; color: var(--text-dim); font-weight: 600; }
        .stat-icon { font-size: 1.2rem; }
        .stat-value { font-size: 1.8rem; font-weight: 700; }
        .stat-unit { font-size: 1rem; color: var(--text-dim); margin-left: 0.25rem; }
        .stat-detail { font-size: 0.8rem; color: var(--text-dim); margin-top: 0.25rem; }
        
        .empty-state { text-align: center; padding: 4rem 2rem; }
        .empty-icon { font-size: 4rem; margin-bottom: 1rem; }
        .empty-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem; }
        .empty-text { color: var(--text-dim); }
        
        .export-section { display: none; margin-bottom: 2rem; }
        .export-section.show { display: block; }
        .export-buttons { display: flex; gap: 1rem; justify-content: center; }
        .export-btn { display: flex; align-items: center; gap: 0.5rem; padding: 0.8rem 1.5rem; border: 2px solid var(--border); background: var(--bg-card); border-radius: 10px; cursor: pointer; font-family: inherit; font-size: 0.9rem; color: var(--text); transition: all 0.2s ease; }
        .export-btn:hover { border-color: var(--blue); background: var(--blue-light); }
        .export-btn .export-icon { font-size: 1.2rem; }
        .export-btn.pdf:hover { border-color: var(--red); background: var(--red-light); }
        .export-btn.excel:hover { border-color: var(--green); background: var(--green-light); }
        
        /* Admin Panels */
        .admin-panel { display: none; }
        .admin-panel.show { display: block; }
        .admin-panel-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        .admin-panel-icon { font-size: 2rem; }
        .admin-panel-title { font-size: 1.3rem; font-weight: 700; }
        .admin-panel-subtitle { color: var(--text-dim); font-size: 0.85rem; }
        
        .config-section { margin-bottom: 1.5rem; padding: 1.25rem; background: var(--bg-input); border-radius: 12px; }
        .config-section-title { font-size: 0.85rem; font-weight: 600; color: var(--blue); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .config-row { display: flex; gap: 1rem; margin-top: 1rem; }
        .config-row .btn { flex: 1; }
        
        /* Users Table */
        .users-table-container { overflow-x: auto; margin-top: 1rem; }
        .users-table { width: 100%; border-collapse: collapse; }
        .users-table th, .users-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border); }
        .users-table th { background: var(--bg-input); font-size: 0.75rem; text-transform: uppercase; color: var(--text-dim); font-weight: 600; }
        .users-table tr:hover { background: var(--bg-input); }
        .users-table .status-badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        .users-table .status-active { background: var(--green-light); color: var(--green); }
        .users-table .status-expired { background: var(--red-light); color: var(--red); }
        .users-table .status-inactive { background: var(--bg-input); color: var(--text-dim); }
        .users-table .action-btns { display: flex; gap: 0.5rem; }
        .users-table .action-btn { padding: 0.3rem 0.6rem; border: 1px solid var(--border); background: transparent; border-radius: 4px; cursor: pointer; font-size: 0.75rem; color: var(--text-dim); }
        .users-table .action-btn:hover { background: var(--bg-input); }
        .users-table .action-btn.delete:hover { background: var(--red-light); color: var(--red); border-color: var(--red); }
        
        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: var(--bg-card); border-radius: 16px; padding: 2rem; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.2rem; font-weight: 700; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-dim); }
        .modal-close:hover { color: var(--text); }
        .modal-footer { display: flex; gap: 1rem; margin-top: 1.5rem; }
        .modal-footer .btn { flex: 1; }
        
        .footer { text-align: center; padding: 1rem; color: var(--text-dim); font-size: 0.75rem; }
        
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15,23,42,0.9); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; gap: 1rem; }
        .loading-overlay.show { display: flex; }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid var(--border); border-top-color: var(--green); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: var(--text); font-size: 1rem; }
        
        @media (max-width: 900px) { .controls-grid.show { grid-template-columns: 1fr; } .chart-container { height: 320px; } .admin-menu-bar { flex-wrap: wrap; } }
        @media (max-width: 600px) { .indicator-btns { flex-direction: column; } .export-buttons { flex-direction: column; } .config-row { flex-direction: column; } }
    </style>
</head>
<body>

<!-- Loading overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Chargement...</div>
</div>

<!-- Modal pour cr√©ation/√©dition utilisateur -->
<div class="modal-overlay" id="userModal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title" id="userModalTitle">Nouvel utilisateur</span>
            <button class="modal-close" id="closeUserModal">&times;</button>
        </div>
        <div class="alert" id="userModalAlert"></div>
        <div class="form-group">
            <label class="form-label">Email *</label>
            <input type="email" class="form-input" id="userEmail" placeholder="email@exemple.com">
        </div>
        <div class="form-group">
            <label class="form-label">Mot de passe *</label>
            <input type="password" class="form-input" id="userPassword" placeholder="Mot de passe">
        </div>
        <div class="form-group">
            <label class="form-label">Nom *</label>
            <input type="text" class="form-input" id="userNom" placeholder="DUPONT">
        </div>
        <div class="form-group">
            <label class="form-label">Pr√©nom</label>
            <input type="text" class="form-input" id="userPrenom" placeholder="Jean">
        </div>
        <div class="form-group">
            <label class="form-label">R√¥le *</label>
            <select class="form-input" id="userRole">
                <option value="eleveur">√âleveur</option>
                <option value="technicien">Technicien</option>
                <option value="admin">Administrateur</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">√âleveur associ√© (pour r√¥le √âleveur)</label>
            <select class="form-input" id="userEleveurId">
                <option value="">-- Aucun --</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Date d'expiration</label>
            <input type="date" class="form-input" id="userExpiration">
        </div>
        <div class="form-group">
            <label class="form-label">
                <input type="checkbox" id="userIsActive" checked> Compte actif
            </label>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancelUserModal">Annuler</button>
            <button class="btn btn-primary" id="saveUserModal">Enregistrer</button>
        </div>
    </div>
</div>

<!-- PAGE LOGIN -->
<div class="page active" id="pageLogin">
    <div class="login-box">
        <div style="position: absolute; top: 1rem; right: 1rem;">
            <button class="theme-toggle" id="themeToggleLogin" title="Changer de th√®me">üåô</button>
        </div>
        <div class="card" style="padding-top: 2rem;">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <img src="Logo_Dataferme.png" alt="Dataferme" style="width: 240px; height: auto;">
            </div>
            <div class="alert" id="loginAlert"></div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="text" class="form-input" id="loginUser" placeholder="email@exemple.com">
            </div>
            <div class="form-group">
                <label class="form-label">Mot de passe</label>
                <input type="password" class="form-input" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button class="btn btn-primary btn-full" id="loginBtn">Se connecter</button>
            <div class="status-box" id="dbStatus"><span id="dbStatusText">Chargement configuration...</span></div>
        </div>
    </div>
</div>

<!-- SESSION BAR -->
<div class="session-bar" id="sessionBar">
    <button class="theme-toggle" id="themeToggle" title="Changer de th√®me">üåô</button>
    <span class="session-user" id="sessionUser">üë§</span>
    <span class="session-role" id="sessionRole">-</span>
    <button class="session-btn" id="btnLogout">D√©connexion</button>
</div>

<!-- PAGE APP -->
<div class="page page-app" id="pageApp">
    
    <!-- Admin Menu Bar -->
    <div class="admin-menu-bar" id="adminMenuBar">
        <span class="admin-menu-label">‚öôÔ∏è Administration</span>
        <div class="admin-menu-buttons">
            <button class="admin-menu-btn" id="menuDashboard" data-panel="dashboard">
                <span class="menu-icon">üìä</span> Tableau de bord
            </button>
            <button class="admin-menu-btn" id="menuApiConfig" data-panel="apiConfig">
                <span class="menu-icon">üîå</span> Config API Tuffigo
            </button>
            <button class="admin-menu-btn" id="menuUsers" data-panel="users">
                <span class="menu-icon">üë•</span> Gestion utilisateurs
            </button>
        </div>
    </div>
    
    <div class="container">
        <header class="app-header">
            <div class="app-logo">
                <img src="Logo_Dataferme.png" alt="Dataferme" style="height: 60px; width: auto;">
            </div>
        </header>
        
        <!-- PANEL: Dashboard (default) -->
        <div class="admin-panel show" id="panelDashboard">
            
            <!-- Banni√®re √©leveur -->
            <div class="eleveur-banner" id="eleveurBanner">
                <div class="eleveur-banner-icon">üë®‚Äçüåæ</div>
                <div class="eleveur-banner-info">
                    <div class="eleveur-banner-label">Votre exploitation</div>
                    <div class="eleveur-banner-name" id="eleveurBannerName">--</div>
                    <div class="eleveur-banner-detail" id="eleveurBannerDetail">--</div>
                </div>
            </div>
            
            <!-- S√©lecteurs -->
            <div class="selectors-card">
                <div class="selectors-grid">
                    <div class="selector-group" id="groupEleveur">
                        <label>√âleveur</label>
                        <select class="selector-select" id="selEleveur"><option value="">-- S√©lectionner --</option></select>
                    </div>
                    <div class="selector-group">
                        <label>Site</label>
                        <select class="selector-select" id="selSite" disabled><option value="">-- S√©lectionner --</option></select>
                    </div>
                    <div class="selector-group">
                        <label>B√¢timent</label>
                        <select class="selector-select" id="selBatiment" disabled><option value="">-- S√©lectionner --</option></select>
                    </div>
                    <div class="selector-group">
                        <label>Lot</label>
                        <select class="selector-select" id="selLot" disabled><option value="">-- S√©lectionner --</option></select>
                    </div>
                </div>
            </div>
            
            <!-- Lot info -->
            <div class="lot-card" id="lotCard">
                <div class="lot-title">üê• Lot s√©lectionn√©</div>
                <div class="lot-grid">
                    <div class="lot-item"><div class="lot-label">Code</div><div class="lot-value" id="lotCode">--</div></div>
                    <div class="lot-item"><div class="lot-label">Souche</div><div class="lot-value" id="lotSouche">--</div></div>
                    <div class="lot-item"><div class="lot-label">Effectif</div><div class="lot-value highlight" id="lotEffectif">--</div></div>
                    <div class="lot-item"><div class="lot-label">Mise en place</div><div class="lot-value" id="lotDate">--</div></div>
                    <div class="lot-item"><div class="lot-label">√Çge</div><div class="lot-value highlight" id="lotAge">--</div></div>
                    <div class="lot-item"><div class="lot-label">Statut</div><div class="lot-value" id="lotStatut">--</div></div>
                </div>
            </div>
            
            <!-- Contr√¥les -->
            <div class="controls-grid" id="controlsGrid">
                <div class="control-card">
                    <div class="control-title">Type de donn√©es <span class="control-hint">(1 ou 2 indicateurs)</span></div>
                    <div class="indicator-btns" id="indicatorBtns">
                        <button class="indicator-btn selected-y1" data-type="poids"><span class="icon">üìà</span>Croissance en poids<span class="axis-tag">Y1</span></button>
                        <button class="indicator-btn" data-type="mortalite"><span class="icon">‚ö†Ô∏è</span>Mortalit√©<span class="axis-tag"></span></button>
                        <button class="indicator-btn" data-type="aliment"><span class="icon">üåæ</span>Consommation aliment<span class="axis-tag"></span></button>
                        <button class="indicator-btn" data-type="oeufs"><span class="icon">ü•ö</span>≈íufs pondus<span class="axis-tag"></span></button>
                    </div>
                </div>
                <div class="control-card">
                    <div class="control-title">P√©riode d'analyse</div>
                    <div class="period-btns" id="periodBtns">
                        <button class="period-btn" data-period="7">1 sem.</button>
                        <button class="period-btn" data-period="28">4 sem.</button>
                        <button class="period-btn active" data-period="56">8 sem.</button>
                        <button class="period-btn" data-period="all">Tout</button>
                    </div>
                </div>
            </div>
            
            <!-- Graphique -->
            <div class="chart-card" id="chartCard">
                <div class="chart-header">
                    <div>
                        <div class="chart-title" id="chartTitle">√âvolution</div>
                        <div class="chart-subtitle" id="chartSubtitle">--</div>
                    </div>
                    <div class="chart-legend" id="chartLegend"></div>
                </div>
                <div class="chart-container"><canvas id="mainChart"></canvas></div>
            </div>
            
            <!-- Stats -->
            <div class="stats-row" id="statsRow">
                <div class="stat-card" id="statCard1">
                    <div class="stat-header"><span class="stat-title" id="statTitle1">--</span><span class="stat-icon" id="statIcon1">üìà</span></div>
                    <div class="stat-value"><span id="statValue1">--</span><span class="stat-unit" id="statUnit1"></span></div>
                    <div class="stat-detail" id="statDetail1">--</div>
                </div>
                <div class="stat-card" id="statCard2">
                    <div class="stat-header"><span class="stat-title" id="statTitle2">--</span><span class="stat-icon" id="statIcon2">‚ö†Ô∏è</span></div>
                    <div class="stat-value"><span id="statValue2">--</span><span class="stat-unit" id="statUnit2"></span></div>
                    <div class="stat-detail" id="statDetail2">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><span class="stat-title">Points</span><span class="stat-icon">üìä</span></div>
                    <div class="stat-value"><span id="dataCount">0</span></div>
                    <div class="stat-detail" id="dataPeriod">--</div>
                </div>
            </div>
            
            <!-- Export buttons -->
            <div class="export-section" id="exportSection">
                <div class="export-buttons">
                    <button class="export-btn pdf" id="btnExportPDF">
                        <span class="export-icon">üìÑ</span> Export PDF
                    </button>
                    <button class="export-btn excel" id="btnExportExcel">
                        <span class="export-icon">üìä</span> Export Excel
                    </button>
                </div>
            </div>
            
            <!-- Empty -->
            <div class="chart-card show" id="emptyState">
                <div class="empty-state">
                    <div class="empty-icon">üìä</div>
                    <div class="empty-title">S√©lectionnez un lot</div>
                    <div class="empty-text">Choisissez un site ‚Üí b√¢timent ‚Üí lot</div>
                </div>
            </div>
            
        </div>
        
        <!-- PANEL: API Config -->
        <div class="admin-panel" id="panelApiConfig">
            <div class="admin-panel-header">
                <span class="admin-panel-icon">üîå</span>
                <div>
                    <div class="admin-panel-title">Configuration API Tuffigo</div>
                    <div class="admin-panel-subtitle">G√©rer la connexion √† l'API Tuffigo Rapidex</div>
                </div>
            </div>
            
            <div class="card">
                <div class="alert" id="apiConfigAlert"></div>
                
                <div class="config-section">
                    <div class="config-section-title">üîë Cl√© API Tuffigo</div>
                    <div class="form-group">
                        <label class="form-label">Cl√© API</label>
                        <input type="password" class="form-input" id="tuffigoApiKey" placeholder="Entrez la cl√© API Tuffigo">
                    </div>
                    <div class="form-group">
                        <label class="form-label">URL de base (optionnel)</label>
                        <input type="url" class="form-input" id="tuffigoBaseUrl" placeholder="https://api.tuffigo.com">
                    </div>
                    <div class="config-row">
                        <button class="btn btn-secondary" id="btnShowApiKey">üëÅÔ∏è Afficher</button>
                        <button class="btn btn-primary" id="btnSaveApiConfig">üíæ Enregistrer</button>
                    </div>
                </div>
                
                <div class="config-section">
                    <div class="config-section-title">üìä Statut de la configuration</div>
                    <div id="apiConfigStatus">
                        <p style="color: var(--text-dim);">Chargement...</p>
                    </div>
                </div>
                
                <div class="config-section">
                    <div class="config-section-title">üîÑ Derni√®re synchronisation</div>
                    <div id="lastSyncInfo">
                        <p style="color: var(--text-dim);">Aucune synchronisation</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PANEL: Users Management -->
        <div class="admin-panel" id="panelUsers">
            <div class="admin-panel-header">
                <span class="admin-panel-icon">üë•</span>
                <div>
                    <div class="admin-panel-title">Gestion des utilisateurs</div>
                    <div class="admin-panel-subtitle">Cr√©er et g√©rer les comptes utilisateurs</div>
                </div>
            </div>
            
            <div class="card">
                <div class="alert" id="usersAlert"></div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <span id="usersCount" style="color: var(--text-dim);">0 utilisateurs</span>
                    </div>
                    <button class="btn btn-primary" id="btnNewUser">‚ûï Nouvel utilisateur</button>
                </div>
                
                <div class="users-table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Utilisateur</th>
                                <th>R√¥le</th>
                                <th>√âleveur</th>
                                <th>Expiration</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr><td colspan="6" style="text-align: center; color: var(--text-dim);">Chargement...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="footer">Dataferme v15.6 - ADOSI</div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    var CONFIG = { supabase_url: null, supabase_anon_key: null };
    var supabase = null;
    var currentUser = null;
    var currentEleveur = null;
    var currentSite = null;
    var currentBatiment = null;
    var mainChart = null;
    var editingUserId = null;
    
    var lotData = { poids: [], mortalite: [], aliment: [], oeufs: [] };
    var standardsData = { poids: [], mortalite: [], aliment: [], oeufs: [] };
    var selectedIndicators = ['poids'];
    var currentPeriod = '56';
    var currentLotInfo = null;
    var allEleveursList = [];
    
    var INDICATORS = {
        poids: { label: 'Croissance en poids', unit: 'g', color: '#2563eb', colorArea: 'rgba(37,99,235,0.2)', colorBorder: 'rgba(37,99,235,0.5)', icon: 'üìà', dataField: 'poids_moyen', stdMinField: 'poids_min', stdMaxField: 'poids_max' },
        mortalite: { label: 'Mortalit√©', unit: 'morts', color: '#e11d48', colorArea: 'rgba(225,29,72,0.2)', colorBorder: 'rgba(225,29,72,0.5)', icon: '‚ö†Ô∏è', dataField: 'nombre_morts', stdMinField: 'mortalite_min', stdMaxField: 'mortalite_max' },
        aliment: { label: 'Conso. aliment', unit: 'g/j', color: '#ea580c', colorArea: 'rgba(234,88,12,0.2)', colorBorder: 'rgba(234,88,12,0.5)', icon: 'üåæ', dataField: 'conso_par_animal', stdMinField: 'conso_min', stdMaxField: 'conso_max' },
        oeufs: { label: '≈íufs pondus', unit: '≈ìufs', color: '#7c3aed', colorArea: 'rgba(124,58,237,0.2)', colorBorder: 'rgba(124,58,237,0.5)', icon: 'ü•ö', dataField: 'nombre_oeufs', stdMinField: 'taux_ponte_min', stdMaxField: 'taux_ponte_max' }
    };
    
    function $(id) { return document.getElementById(id); }
    function showPage(id) { document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); }); $(id).classList.add('active'); }
    function showAlert(id, type, msg) { var el = $(id); if (el) { el.className = 'alert alert-' + type + ' show'; el.innerHTML = msg; } }
    function hideAlert(id) { var el = $(id); if (el) el.classList.remove('show'); }
    function showLoading(text) { $('loadingText').textContent = text || 'Chargement...'; $('loadingOverlay').classList.add('show'); }
    function hideLoading() { $('loadingOverlay').classList.remove('show'); }
    
    // =====================================================
    // CONFIG
    // =====================================================
    function loadConfig() {
        fetch('config.json')
            .then(function(r) { if (!r.ok) throw new Error('config.json non trouv√©'); return r.json(); })
            .then(function(data) {
                if (!data.supabase_url || !data.supabase_anon_key || data.supabase_anon_key === 'VOTRE_CLE_ANON_ICI') throw new Error('Config incompl√®te');
                CONFIG.supabase_url = data.supabase_url;
                CONFIG.supabase_anon_key = data.supabase_anon_key;
                initSupabase();
            })
            .catch(function(e) { $('dbStatus').className = 'status-box error'; $('dbStatusText').textContent = '‚ùå ' + e.message; });
    }
    
    function initSupabase() {
        try {
            supabase = window.supabase.createClient(CONFIG.supabase_url, CONFIG.supabase_anon_key);
            supabase.from('users').select('id').limit(1).then(function(r) {
                if (r.error) { $('dbStatus').className = 'status-box error'; $('dbStatusText').textContent = '‚ùå Erreur'; }
                else { $('dbStatus').className = 'status-box ok'; $('dbStatusText').textContent = '‚úì Connect√©'; }
            });
        } catch (e) { $('dbStatus').className = 'status-box error'; $('dbStatusText').textContent = '‚ùå ' + e.message; }
    }
    
    // =====================================================
    // AUTH
    // =====================================================
    function doLogin() {
        var user = $('loginUser').value.trim(), pass = $('loginPass').value;
        hideAlert('loginAlert');
        if (!user || !pass) { showAlert('loginAlert', 'error', '‚ùå Remplissez les champs'); return; }
        if (!supabase) { showAlert('loginAlert', 'error', '‚ùå Base non connect√©e'); return; }
        
        var btn = $('loginBtn');
        btn.disabled = true; btn.textContent = 'Connexion...';
        
        supabase.from('users').select('*').eq('email', user).eq('is_active', true).single()
            .then(function(res) {
                if (res.error || !res.data) throw new Error('Utilisateur non trouv√©');
                
                // V√©rifier expiration
                if (res.data.expiration_date) {
                    var expDate = new Date(res.data.expiration_date);
                    if (expDate < new Date()) {
                        throw new Error('Compte expir√©. Contactez l\'administrateur.');
                    }
                }
                
                var storedPass = res.data.password_hash || '';
                if (storedPass !== pass && storedPass !== ('hash_' + pass)) throw new Error('Mot de passe incorrect');
                
                currentUser = res.data;
                var role = res.data.role || 'eleveur';
                var name = ((res.data.prenom || '') + ' ' + res.data.nom).trim();
                
                $('sessionUser').textContent = 'üë§ ' + name;
                $('sessionRole').textContent = role.toUpperCase();
                $('sessionRole').className = 'session-role ' + role;
                $('sessionBar').style.display = 'flex';
                
                if (role === 'eleveur') {
                    // Masquer le menu admin pour les √©leveurs
                    $('adminMenuBar').classList.remove('show');
                    // S'assurer que le dashboard est visible
                    switchAdminPanel('dashboard');
                    
                    return findEleveurForUser(res.data).then(function(eleveur) {
                        if (eleveur) { currentEleveur = eleveur; setupEleveurMode(eleveur); }
                        else {
                            return supabase.from('eleveurs').select('*').ilike('nom', '%' + res.data.nom + '%').eq('is_active', true).maybeSingle()
                                .then(function(r2) {
                                    if (r2 && r2.data) { currentEleveur = r2.data; setupEleveurMode(r2.data); }
                                    else {
                                        $('groupEleveur').classList.add('hidden');
                                        $('eleveurBanner').classList.add('show');
                                        $('eleveurBannerName').textContent = name;
                                        $('eleveurBannerDetail').textContent = '‚ö†Ô∏è Compte non li√©';
                                    }
                                });
                        }
                    }).then(function() { showPage('pageApp'); });
                } else if (role === 'admin') {
                    // Afficher menu admin uniquement pour les admins
                    $('adminMenuBar').classList.add('show');
                    switchAdminPanel('dashboard');
                    currentEleveur = null; 
                    setupAdminMode(); 
                    showPage('pageApp');
                } else {
                    // Technicien : pas de menu admin, mais acc√®s √† tous les √©leveurs
                    $('adminMenuBar').classList.remove('show');
                    switchAdminPanel('dashboard');
                    currentEleveur = null; 
                    setupAdminMode(); 
                    showPage('pageApp'); 
                }
            })
            .catch(function(e) { showAlert('loginAlert', 'error', '‚ùå ' + e.message); })
            .finally(function() { btn.disabled = false; btn.textContent = 'Se connecter'; });
    }
    
    function findEleveurForUser(user) {
        return supabase.from('eleveurs').select('*').eq('user_id', user.id).eq('is_active', true).maybeSingle()
            .then(function(r) {
                if (r.data) return r.data;
                return supabase.from('eleveurs').select('*').eq('email', user.email).eq('is_active', true).maybeSingle();
            })
            .then(function(r) { return (r && r.data) ? r.data : null; })
            .catch(function() { return null; });
    }
    
    function setupEleveurMode(eleveur) {
        $('groupEleveur').classList.add('hidden');
        $('eleveurBanner').classList.add('show');
        $('eleveurBannerName').textContent = eleveur.nom + ' ' + (eleveur.prenom || '');
        $('eleveurBannerDetail').textContent = 'Code: ' + eleveur.code_eleveur + (eleveur.raison_sociale ? ' | ' + eleveur.raison_sociale : '');
        loadSitesForEleveur(eleveur.id);
    }
    
    function setupAdminMode() {
        $('groupEleveur').classList.remove('hidden');
        $('eleveurBanner').classList.remove('show');
        loadAllEleveurs();
    }
    
    function doLogout() {
        currentUser = null; currentEleveur = null;
        $('sessionBar').style.display = 'none';
        $('adminMenuBar').classList.remove('show');
        $('loginUser').value = ''; $('loginPass').value = '';
        hideAlert('loginAlert');
        resetAllSelectors(); hideDataPanels();
        showPage('pageLogin');
    }
    
    // =====================================================
    // ADMIN PANEL SWITCHING
    // =====================================================
    function switchAdminPanel(panelName) {
        // Hide all panels
        document.querySelectorAll('.admin-panel').forEach(function(p) { p.classList.remove('show'); });
        // Show selected panel
        var panel = $('panel' + panelName.charAt(0).toUpperCase() + panelName.slice(1));
        if (panel) panel.classList.add('show');
        
        // Update menu buttons
        document.querySelectorAll('.admin-menu-btn').forEach(function(btn) {
            btn.classList.remove('active');
            if (btn.getAttribute('data-panel') === panelName) btn.classList.add('active');
        });
        
        // Load panel data
        if (panelName === 'apiConfig') loadApiConfig();
        if (panelName === 'users') loadUsers();
    }
    
    // =====================================================
    // API CONFIG MANAGEMENT
    // =====================================================
    function loadApiConfig() {
        supabase.from('api_config').select('*').eq('is_active', true).maybeSingle()
            .then(function(res) {
                if (res.data) {
                    $('tuffigoApiKey').value = res.data.api_key || '';
                    $('tuffigoBaseUrl').value = res.data.base_url || '';
                    $('apiConfigStatus').innerHTML = '<p style="color: var(--green);">‚úì Configuration trouv√©e</p>';
                    if (res.data.last_sync) {
                        $('lastSyncInfo').innerHTML = '<p>Derni√®re sync: ' + new Date(res.data.last_sync).toLocaleString('fr-FR') + '</p>';
                    }
                } else {
                    $('apiConfigStatus').innerHTML = '<p style="color: var(--orange);">‚ö†Ô∏è Aucune configuration</p>';
                }
            })
            .catch(function(err) {
                $('apiConfigStatus').innerHTML = '<p style="color: var(--red);">‚ùå Erreur: ' + err.message + '</p>';
            });
    }
    
    function saveApiConfig() {
        var apiKey = $('tuffigoApiKey').value.trim();
        var baseUrl = $('tuffigoBaseUrl').value.trim();
        
        if (!apiKey) {
            showAlert('apiConfigAlert', 'error', '‚ùå La cl√© API est requise');
            return;
        }
        
        showLoading('Enregistrement...');
        
        // Check if config exists
        supabase.from('api_config').select('id').eq('is_active', true).maybeSingle()
            .then(function(res) {
                var data = {
                    api_key: apiKey,
                    base_url: baseUrl || null,
                    is_active: true,
                    updated_at: new Date().toISOString()
                };
                
                if (res.data) {
                    return supabase.from('api_config').update(data).eq('id', res.data.id);
                } else {
                    data.created_at = new Date().toISOString();
                    return supabase.from('api_config').insert(data);
                }
            })
            .then(function(res) {
                if (res.error) throw res.error;
                showAlert('apiConfigAlert', 'success', '‚úì Configuration enregistr√©e');
                loadApiConfig();
            })
            .catch(function(err) {
                showAlert('apiConfigAlert', 'error', '‚ùå Erreur: ' + err.message);
            })
            .finally(function() { hideLoading(); });
    }
    
    function toggleApiKeyVisibility() {
        var input = $('tuffigoApiKey');
        var btn = $('btnShowApiKey');
        if (input.type === 'password') {
            input.type = 'text';
            btn.textContent = 'üôà Masquer';
        } else {
            input.type = 'password';
            btn.textContent = 'üëÅÔ∏è Afficher';
        }
    }
    
    // =====================================================
    // USERS MANAGEMENT
    // =====================================================
    function loadUsers() {
        supabase.from('users').select('*').order('nom')
            .then(function(res) {
                var users = res.data || [];
                $('usersCount').textContent = users.length + ' utilisateur(s)';
                
                var tbody = $('usersTableBody');
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-dim);">Aucun utilisateur</td></tr>';
                    return;
                }
                
                // Load eleveurs for mapping
                return supabase.from('eleveurs').select('id, nom, prenom, code_eleveur').eq('is_active', true)
                    .then(function(elevRes) {
                        var eleveurs = elevRes.data || [];
                        allEleveursList = eleveurs;
                        
                        var html = '';
                        users.forEach(function(u) {
                            var eleveur = eleveurs.find(function(e) { return e.id === u.eleveur_id; });
                            var eleveurName = eleveur ? (eleveur.nom + ' ' + (eleveur.prenom || '')) : '-';
                            
                            var statusClass = 'status-inactive';
                            var statusText = 'Inactif';
                            if (u.is_active) {
                                if (u.expiration_date && new Date(u.expiration_date) < new Date()) {
                                    statusClass = 'status-expired';
                                    statusText = 'Expir√©';
                                } else {
                                    statusClass = 'status-active';
                                    statusText = 'Actif';
                                }
                            }
                            
                            var expDate = u.expiration_date ? new Date(u.expiration_date).toLocaleDateString('fr-FR') : '-';
                            
                            html += '<tr data-id="' + u.id + '">';
                            html += '<td><strong>' + u.nom + '</strong> ' + (u.prenom || '') + '<br><small style="color:var(--text-dim)">' + u.email + '</small></td>';
                            html += '<td><span class="session-role ' + u.role + '">' + (u.role || 'eleveur').toUpperCase() + '</span></td>';
                            html += '<td>' + eleveurName + '</td>';
                            html += '<td>' + expDate + '</td>';
                            html += '<td><span class="status-badge ' + statusClass + '">' + statusText + '</span></td>';
                            html += '<td><div class="action-btns">';
                            html += '<button class="action-btn edit-user" data-id="' + u.id + '">‚úèÔ∏è</button>';
                            html += '<button class="action-btn delete delete-user" data-id="' + u.id + '">üóëÔ∏è</button>';
                            html += '</div></td>';
                            html += '</tr>';
                        });
                        
                        tbody.innerHTML = html;
                        
                        // Attach event listeners
                        document.querySelectorAll('.edit-user').forEach(function(btn) {
                            btn.addEventListener('click', function() { editUser(this.getAttribute('data-id')); });
                        });
                        document.querySelectorAll('.delete-user').forEach(function(btn) {
                            btn.addEventListener('click', function() { deleteUser(this.getAttribute('data-id')); });
                        });
                    });
            })
            .catch(function(err) {
                showAlert('usersAlert', 'error', '‚ùå Erreur: ' + err.message);
            });
    }
    
    function openUserModal(userId) {
        editingUserId = userId || null;
        $('userModalTitle').textContent = userId ? 'Modifier utilisateur' : 'Nouvel utilisateur';
        hideAlert('userModalAlert');
        
        // Populate eleveurs dropdown
        var eleveurSelect = $('userEleveurId');
        eleveurSelect.innerHTML = '<option value="">-- Aucun --</option>';
        allEleveursList.forEach(function(e) {
            var opt = document.createElement('option');
            opt.value = e.id;
            opt.textContent = e.nom + ' ' + (e.prenom || '') + ' (' + e.code_eleveur + ')';
            eleveurSelect.appendChild(opt);
        });
        
        if (userId) {
            // Load user data
            supabase.from('users').select('*').eq('id', userId).single()
                .then(function(res) {
                    if (res.data) {
                        $('userEmail').value = res.data.email || '';
                        $('userPassword').value = '';
                        $('userPassword').placeholder = '(inchang√© si vide)';
                        $('userNom').value = res.data.nom || '';
                        $('userPrenom').value = res.data.prenom || '';
                        $('userRole').value = res.data.role || 'eleveur';
                        $('userEleveurId').value = res.data.eleveur_id || '';
                        $('userExpiration').value = res.data.expiration_date ? res.data.expiration_date.split('T')[0] : '';
                        $('userIsActive').checked = res.data.is_active !== false;
                    }
                });
        } else {
            // Reset form
            $('userEmail').value = '';
            $('userPassword').value = '';
            $('userPassword').placeholder = 'Mot de passe';
            $('userNom').value = '';
            $('userPrenom').value = '';
            $('userRole').value = 'eleveur';
            $('userEleveurId').value = '';
            $('userExpiration').value = '';
            $('userIsActive').checked = true;
        }
        
        $('userModal').classList.add('show');
    }
    
    function closeUserModal() {
        $('userModal').classList.remove('show');
        editingUserId = null;
    }
    
    function saveUser() {
        var email = $('userEmail').value.trim();
        var password = $('userPassword').value;
        var nom = $('userNom').value.trim();
        var prenom = $('userPrenom').value.trim();
        var role = $('userRole').value;
        var eleveurId = $('userEleveurId').value || null;
        var expiration = $('userExpiration').value || null;
        var isActive = $('userIsActive').checked;
        
        if (!email || !nom) {
            showAlert('userModalAlert', 'error', '‚ùå Email et nom sont requis');
            return;
        }
        if (!editingUserId && !password) {
            showAlert('userModalAlert', 'error', '‚ùå Mot de passe requis pour un nouveau compte');
            return;
        }
        
        showLoading('Enregistrement...');
        
        var data = {
            email: email,
            nom: nom,
            prenom: prenom || null,
            role: role,
            eleveur_id: eleveurId,
            expiration_date: expiration,
            is_active: isActive,
            updated_at: new Date().toISOString()
        };
        
        if (password) {
            data.password_hash = password; // In production, hash this!
        }
        
        var promise;
        if (editingUserId) {
            promise = supabase.from('users').update(data).eq('id', editingUserId);
        } else {
            data.created_at = new Date().toISOString();
            promise = supabase.from('users').insert(data);
        }
        
        promise
            .then(function(res) {
                if (res.error) throw res.error;
                showAlert('usersAlert', 'success', '‚úì Utilisateur enregistr√©');
                closeUserModal();
                loadUsers();
            })
            .catch(function(err) {
                showAlert('userModalAlert', 'error', '‚ùå Erreur: ' + err.message);
            })
            .finally(function() { hideLoading(); });
    }
    
    function editUser(userId) {
        openUserModal(userId);
    }
    
    function deleteUser(userId) {
        if (!confirm('Voulez-vous vraiment supprimer cet utilisateur ?')) return;
        
        showLoading('Suppression...');
        supabase.from('users').delete().eq('id', userId)
            .then(function(res) {
                if (res.error) throw res.error;
                showAlert('usersAlert', 'success', '‚úì Utilisateur supprim√©');
                loadUsers();
            })
            .catch(function(err) {
                showAlert('usersAlert', 'error', '‚ùå Erreur: ' + err.message);
            })
            .finally(function() { hideLoading(); });
    }
    
    // =====================================================
    // DATA LOADING (Dashboard)
    // =====================================================
    function loadAllEleveurs() {
        if (!supabase) return;
        supabase.from('eleveurs').select('*').eq('is_active', true).order('nom').then(function(r) {
            var sel = $('selEleveur');
            sel.innerHTML = '<option value="">-- S√©lectionner --</option>';
            (r.data || []).forEach(function(e) {
                var opt = document.createElement('option');
                opt.value = e.id; opt.setAttribute('data-json', JSON.stringify(e));
                opt.textContent = e.nom + ' ' + (e.prenom || '') + ' (' + e.code_eleveur + ')';
                sel.appendChild(opt);
            });
        });
    }
    
    function loadSitesForEleveur(eleveurId) {
        if (!supabase || !eleveurId) return;
        supabase.from('sites').select('*').eq('eleveur_id', eleveurId).eq('is_active', true).order('nom').then(function(r) {
            var sel = $('selSite');
            sel.innerHTML = '<option value="">-- S√©lectionner --</option>';
            sel.disabled = false;
            var sites = r.data || [];
            sites.forEach(function(s) {
                var opt = document.createElement('option');
                opt.value = s.id; opt.setAttribute('data-json', JSON.stringify(s));
                opt.textContent = s.nom + (s.ville ? ' (' + s.ville + ')' : '');
                sel.appendChild(opt);
            });
            if (sites.length === 1) { sel.value = sites[0].id; onSiteChange(); }
        });
    }
    
    function onEleveurChange() {
        var sel = $('selEleveur');
        var opt = sel.options[sel.selectedIndex];
        if (opt && opt.value) {
            try { currentEleveur = JSON.parse(opt.getAttribute('data-json')); } catch(e) {}
        }
        resetSelectors('site');
        if (sel.value) loadSitesForEleveur(sel.value);
    }
    
    function onSiteChange() {
        var sel = $('selSite');
        var opt = sel.options[sel.selectedIndex];
        if (opt && opt.value) {
            try { currentSite = JSON.parse(opt.getAttribute('data-json')); } catch(e) {}
        }
        resetSelectors('batiment');
        if (!sel.value) return;
        supabase.from('batiments').select('*').eq('site_id', sel.value).eq('is_active', true).order('nom').then(function(r) {
            var s = $('selBatiment');
            s.innerHTML = '<option value="">-- S√©lectionner --</option>';
            s.disabled = false;
            var bats = r.data || [];
            bats.forEach(function(b) {
                var opt = document.createElement('option');
                opt.value = b.id; opt.setAttribute('data-json', JSON.stringify(b));
                opt.textContent = b.nom + (b.capacite ? ' (cap.' + b.capacite + ')' : '');
                s.appendChild(opt);
            });
            if (bats.length === 1) { s.value = bats[0].id; onBatimentChange(); }
        });
    }
    
    function onBatimentChange() {
        var sel = $('selBatiment');
        var opt = sel.options[sel.selectedIndex];
        if (opt && opt.value) {
            try { currentBatiment = JSON.parse(opt.getAttribute('data-json')); } catch(e) {}
        }
        resetSelectors('lot');
        if (!sel.value) return;
        
        supabase.from('lots').select('*').eq('batiment_id', sel.value).order('date_mise_place', { ascending: false })
            .then(function(r) {
                var s = $('selLot');
                s.innerHTML = '<option value="">-- S√©lectionner --</option>';
                s.disabled = false;
                var lots = r.data || [];
                lots.forEach(function(l) {
                    var opt = document.createElement('option');
                    opt.value = l.id; opt.setAttribute('data-json', JSON.stringify(l));
                    opt.textContent = (l.statut === 'actif' ? 'üü¢ ' : '‚ö™ ') + l.code_lot;
                    s.appendChild(opt);
                });
                var actif = lots.find(function(l) { return l.statut === 'actif'; });
                if (actif) { s.value = actif.id; onLotChange(); }
            });
    }
    
    function onLotChange() {
        var id = $('selLot').value;
        if (!id) { hideDataPanels(); return; }
        var opt = document.querySelector('#selLot option[value="' + id + '"]');
        var lot = {}; try { lot = JSON.parse(opt.getAttribute('data-json') || '{}'); } catch (e) {}
        currentLotInfo = lot;
        
        $('lotCode').textContent = lot.code_lot || '--';
        $('lotEffectif').textContent = lot.effectif_depart ? lot.effectif_depart.toLocaleString('fr-FR') : '--';
        $('lotDate').textContent = lot.date_mise_place ? new Date(lot.date_mise_place).toLocaleDateString('fr-FR') : '--';
        $('lotAge').textContent = lot.date_mise_place ? Math.floor((Date.now() - new Date(lot.date_mise_place)) / 86400000) + ' jours' : '--';
        $('lotStatut').textContent = lot.statut || '--';
        
        // Load souche
        if (lot.souche_id) {
            supabase.from('souches').select('id, nom, type').eq('id', lot.souche_id).single()
                .then(function(soucheRes) {
                    if (soucheRes.data && soucheRes.data.nom) {
                        currentLotInfo.souche_nom = soucheRes.data.nom;
                        $('lotSouche').textContent = soucheRes.data.nom;
                    } else { $('lotSouche').textContent = '--'; }
                })
                .catch(function() { $('lotSouche').textContent = '--'; });
        } else { $('lotSouche').textContent = '--'; }
        
        Promise.all([
            supabase.from('donnees_poids').select('*').eq('lot_id', id).order('jour_age'),
            supabase.from('donnees_mortalite').select('*').eq('lot_id', id).order('jour_age'),
            supabase.from('donnees_aliment').select('*').eq('lot_id', id).order('jour_age'),
            supabase.from('donnees_oeufs').select('*').eq('lot_id', id).order('jour_age')
        ]).then(function(r) {
            lotData.poids = r[0].data || [];
            lotData.mortalite = r[1].data || [];
            lotData.aliment = r[2].data || [];
            lotData.oeufs = r[3].data || [];
            if (lot.souche_id) loadStandards(lot.souche_id);
            else { showDataPanels(); updateUI(); }
        });
    }
    
    function loadStandards(soucheId) {
        Promise.all([
            supabase.from('standards_poids').select('*').eq('souche_id', soucheId).order('jour_age'),
            supabase.from('standards_mortalite').select('*').eq('souche_id', soucheId).order('jour_age'),
            supabase.from('standards_aliment').select('*').eq('souche_id', soucheId).order('jour_age'),
            supabase.from('standards_oeufs').select('*').eq('souche_id', soucheId).order('jour_age')
        ]).then(function(r) {
            standardsData.poids = r[0].data || [];
            standardsData.mortalite = r[1].data || [];
            standardsData.aliment = r[2].data || [];
            standardsData.oeufs = r[3].data || [];
            showDataPanels(); updateUI();
        });
    }
    
    function resetSelectors(from) {
        var order = ['site', 'batiment', 'lot'];
        var start = order.indexOf(from);
        for (var i = start; i < order.length; i++) {
            var sel = $('sel' + order[i].charAt(0).toUpperCase() + order[i].slice(1));
            sel.innerHTML = '<option value="">-- S√©lectionner --</option>';
            sel.disabled = true;
        }
        hideDataPanels();
    }
    
    function resetAllSelectors() {
        $('selEleveur').innerHTML = '<option value="">-- S√©lectionner --</option>';
        resetSelectors('site');
    }
    
    function showDataPanels() {
        $('lotCard').classList.add('show');
        $('controlsGrid').classList.add('show');
        $('chartCard').classList.add('show');
        $('statsRow').classList.add('show');
        $('exportSection').classList.add('show');
        $('emptyState').classList.remove('show');
    }
    
    function hideDataPanels() {
        $('lotCard').classList.remove('show');
        $('controlsGrid').classList.remove('show');
        $('chartCard').classList.remove('show');
        $('statsRow').classList.remove('show');
        $('exportSection').classList.remove('show');
        $('emptyState').classList.add('show');
    }
    
    // =====================================================
    // UI UPDATE
    // =====================================================
    function updateUI() { updateChart(); updateStats(); updateLegend(); }
    
    function updateStats() {
        var t1 = selectedIndicators[0], ind1 = INDICATORS[t1], d1 = lotData[t1] || [];
        $('statTitle1').textContent = ind1.label;
        $('statIcon1').textContent = ind1.icon;
        $('statUnit1').textContent = ind1.unit;
        if (d1.length > 0) {
            var last = d1[d1.length - 1];
            $('statValue1').textContent = Math.round(parseFloat(last[ind1.dataField]) || 0);
            $('statDetail1').textContent = 'Jour ' + last.jour_age;
        } else { $('statValue1').textContent = '--'; $('statDetail1').textContent = 'Pas de donn√©es'; }
        
        if (selectedIndicators[1]) {
            var t2 = selectedIndicators[1], ind2 = INDICATORS[t2], d2 = lotData[t2] || [];
            $('statCard2').classList.remove('hidden');
            $('statTitle2').textContent = ind2.label;
            $('statIcon2').textContent = ind2.icon;
            $('statUnit2').textContent = ind2.unit;
            if (d2.length > 0) {
                var last2 = d2[d2.length - 1];
                $('statValue2').textContent = Math.round(parseFloat(last2[ind2.dataField]) || 0);
                $('statDetail2').textContent = 'Jour ' + last2.jour_age;
            } else { $('statValue2').textContent = '--'; $('statDetail2').textContent = 'Pas de donn√©es'; }
        } else { $('statCard2').classList.add('hidden'); }
        
        var total = 0;
        selectedIndicators.forEach(function(t) { total += (lotData[t] || []).length; });
        $('dataCount').textContent = total;
        $('dataPeriod').textContent = currentPeriod === 'all' ? 'Tout' : currentPeriod + 'j';
    }
    
    function updateLegend() {
        var html = '';
        selectedIndicators.forEach(function(type, idx) {
            var ind = INDICATORS[type];
            var axis = idx === 0 ? 'Y1' : 'Y2';
            html += '<div class="legend-item"><span class="legend-line" style="background:' + ind.color + '"></span>' + ind.label + ' (' + axis + ')</div>';
            html += '<div class="legend-item"><span class="legend-area" style="background:' + ind.colorArea + '"></span>Zone ' + axis + '</div>';
        });
        $('chartLegend').innerHTML = html;
    }
    
    function updateChart() {
        var canvas = $('mainChart');
        if (!canvas) return;
        var ctx = canvas.getContext('2d');
        if (mainChart) { mainChart.destroy(); mainChart = null; }
        
        var t1 = selectedIndicators[0], t2 = selectedIndicators[1];
        var ind1 = INDICATORS[t1];
        var d1 = filterByPeriod(lotData[t1] || []);
        var std1 = standardsData[t1] || [];
        
        if (d1.length === 0) { $('chartTitle').textContent = 'Aucune donn√©e'; $('chartSubtitle').textContent = ''; return; }
        
        var labels = d1.map(function(d) { return 'J' + d.jour_age; });
        var jours = d1.map(function(d) { return d.jour_age; });
        
        var title = ind1.label;
        if (t2) title += ' vs ' + INDICATORS[t2].label;
        $('chartTitle').textContent = title;
        $('chartSubtitle').textContent = t2 ? 'Comparaison sur deux axes' : '√âvolution';
        
        var datasets = [];
        
        // Stocker les donn√©es de tol√©rance pour le tooltip
        var toleranceData = { y1: { min: [], max: [] }, y2: { min: [], max: [] } };
        
        // Y1 Zone
        var min1 = [], max1 = [];
        jours.forEach(function(j) {
            var s = std1.find(function(x) { return x.jour_age === j; });
            min1.push(s ? (parseFloat(s[ind1.stdMinField]) || null) : null);
            max1.push(s ? (parseFloat(s[ind1.stdMaxField]) || null) : null);
        });
        toleranceData.y1.min = min1;
        toleranceData.y1.max = max1;
        
        if (max1.some(function(v) { return v !== null; })) {
            datasets.push({ label: '_z1max', data: max1, borderColor: 'transparent', backgroundColor: ind1.colorArea, fill: '+1', pointRadius: 0, yAxisID: 'y1', order: 100 });
            datasets.push({ label: '_z1min', data: min1, borderColor: ind1.colorBorder, borderWidth: 1, borderDash: [5,5], backgroundColor: 'transparent', fill: false, pointRadius: 0, yAxisID: 'y1', order: 99 });
            datasets.push({ label: '_z1maxL', data: max1, borderColor: ind1.colorBorder, borderWidth: 1, borderDash: [5,5], backgroundColor: 'transparent', fill: false, pointRadius: 0, yAxisID: 'y1', order: 99 });
        }
        
        var v1 = d1.map(function(d) { return parseFloat(d[ind1.dataField]) || 0; });
        datasets.push({ 
            label: ind1.label, 
            data: v1, 
            borderColor: ind1.color, 
            backgroundColor: ind1.color, 
            borderWidth: 2, 
            tension: 0.35, 
            fill: false, 
            pointRadius: 2,
            pointHoverRadius: 5,
            pointBackgroundColor: ind1.color,
            pointBorderColor: ind1.color,
            pointBorderWidth: 0,
            yAxisID: 'y1', 
            order: 1 
        });
        
        var scales = {
            x: { grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--chart-grid').trim() || 'rgba(71,85,105,0.3)' }, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--chart-text').trim() || '#94a3b8', maxTicksLimit: 15 }, title: { display: true, text: 'Jours du cycle', color: getComputedStyle(document.documentElement).getPropertyValue('--text-dim').trim() || '#64748b' } },
            y1: { type: 'linear', position: 'left', grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--chart-grid').trim() || 'rgba(71,85,105,0.3)' }, ticks: { color: ind1.color }, title: { display: true, text: ind1.label + ' (' + ind1.unit + ')', color: ind1.color } }
        };
        
        if (t2) {
            var ind2 = INDICATORS[t2];
            var d2 = filterByPeriod(lotData[t2] || []);
            var std2 = standardsData[t2] || [];
            
            var min2 = [], max2 = [];
            jours.forEach(function(j) {
                var s = std2.find(function(x) { return x.jour_age === j; });
                min2.push(s ? (parseFloat(s[ind2.stdMinField]) || null) : null);
                max2.push(s ? (parseFloat(s[ind2.stdMaxField]) || null) : null);
            });
            toleranceData.y2.min = min2;
            toleranceData.y2.max = max2;
            
            if (max2.some(function(v) { return v !== null; })) {
                datasets.push({ label: '_z2max', data: max2, borderColor: 'transparent', backgroundColor: ind2.colorArea, fill: '+1', pointRadius: 0, yAxisID: 'y2', order: 98 });
                datasets.push({ label: '_z2min', data: min2, borderColor: ind2.colorBorder, borderWidth: 1, borderDash: [5,5], backgroundColor: 'transparent', fill: false, pointRadius: 0, yAxisID: 'y2', order: 97 });
                datasets.push({ label: '_z2maxL', data: max2, borderColor: ind2.colorBorder, borderWidth: 1, borderDash: [5,5], backgroundColor: 'transparent', fill: false, pointRadius: 0, yAxisID: 'y2', order: 97 });
            }
            
            var v2 = jours.map(function(j) {
                var d = d2.find(function(x) { return x.jour_age === j; });
                return d ? (parseFloat(d[ind2.dataField]) || 0) : null;
            });
            datasets.push({ 
                label: ind2.label, 
                data: v2, 
                borderColor: ind2.color, 
                backgroundColor: ind2.color, 
                borderWidth: 2, 
                tension: 0.35, 
                fill: false, 
                pointRadius: 2,
                pointHoverRadius: 5,
                pointBackgroundColor: ind2.color,
                pointBorderColor: ind2.color,
                pointBorderWidth: 0,
                yAxisID: 'y2', 
                order: 2 
            });
            
            scales.y2 = { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, ticks: { color: ind2.color }, title: { display: true, text: ind2.label + ' (' + ind2.unit + ')', color: ind2.color } };
        }
        
        // Configuration du tooltip personnalis√©
        var tooltipConfig = {
            enabled: true,
            backgroundColor: 'rgba(15, 23, 42, 0.95)',
            titleColor: '#f8fafc',
            titleFont: { size: 14, weight: 'bold' },
            bodyColor: '#e2e8f0',
            bodyFont: { size: 12 },
            borderColor: 'rgba(71, 85, 105, 0.8)',
            borderWidth: 1,
            cornerRadius: 8,
            padding: 12,
            displayColors: true,
            boxWidth: 12,
            boxHeight: 12,
            boxPadding: 6,
            usePointStyle: true,
            filter: function(tooltipItem) {
                return !tooltipItem.dataset.label.startsWith('_');
            },
            callbacks: {
                title: function(tooltipItems) {
                    return 'üìÖ ' + tooltipItems[0].label;
                },
                label: function(context) {
                    var value = context.parsed.y;
                    var index = context.dataIndex;
                    
                    // D√©terminer l'indicateur et l'unit√©
                    var isY1 = context.dataset.yAxisID === 'y1';
                    var ind = isY1 ? ind1 : (t2 ? INDICATORS[t2] : null);
                    var unit = ind ? ind.unit : '';
                    var label = context.dataset.label;
                    
                    // Valeur principale
                    return ' ' + label + ': ' + value.toLocaleString('fr-FR') + ' ' + unit;
                },
                afterLabel: function(context) {
                    var index = context.dataIndex;
                    var isY1 = context.dataset.yAxisID === 'y1';
                    var ind = isY1 ? ind1 : (t2 ? INDICATORS[t2] : null);
                    var unit = ind ? ind.unit : '';
                    var value = context.parsed.y;
                    
                    // Tol√©rance
                    var tolMin, tolMax;
                    if (isY1) {
                        tolMin = toleranceData.y1.min[index];
                        tolMax = toleranceData.y1.max[index];
                    } else {
                        tolMin = toleranceData.y2.min[index];
                        tolMax = toleranceData.y2.max[index];
                    }
                    
                    var lines = [];
                    if (tolMin !== null && tolMax !== null) {
                        lines.push('   ‚Ü≥ Min: ' + tolMin.toLocaleString('fr-FR') + ' ' + unit);
                        lines.push('   ‚Ü≥ Max: ' + tolMax.toLocaleString('fr-FR') + ' ' + unit);
                        
                        // Indicateur de position
                        if (value < tolMin) {
                            lines.push('   ‚ö†Ô∏è Sous le seuil minimum');
                        } else if (value > tolMax) {
                            lines.push('   ‚ö†Ô∏è Au-dessus du seuil maximum');
                        } else {
                            lines.push('   ‚úÖ Dans la zone de tol√©rance');
                        }
                    }
                    
                    return lines;
                }
            }
        };
        
        mainChart = new Chart(ctx, {
            type: 'line', 
            data: { labels: labels, datasets: datasets },
            options: {
                responsive: true, 
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: { 
                    legend: { display: false }, 
                    tooltip: tooltipConfig
                },
                scales: scales
            }
        });
    }
    
    function filterByPeriod(data) {
        if (!data || !data.length || currentPeriod === 'all') return data;
        return data.slice(-parseInt(currentPeriod));
    }
    
    function onIndicatorClick(e) {
        var btn = e.currentTarget, type = btn.getAttribute('data-type');
        var idx = selectedIndicators.indexOf(type);
        if (idx === 0) { if (selectedIndicators.length > 1) selectedIndicators = [selectedIndicators[1]]; }
        else if (idx === 1) { selectedIndicators = [selectedIndicators[0]]; }
        else { if (selectedIndicators.length < 2) selectedIndicators.push(type); else selectedIndicators[1] = type; }
        updateIndicatorButtons(); updateUI();
    }
    
    function updateIndicatorButtons() {
        document.querySelectorAll('#indicatorBtns .indicator-btn').forEach(function(btn) {
            var type = btn.getAttribute('data-type'), tag = btn.querySelector('.axis-tag');
            btn.classList.remove('selected-y1', 'selected-y2'); tag.textContent = '';
            if (selectedIndicators[0] === type) { btn.classList.add('selected-y1'); tag.textContent = 'Y1'; }
            else if (selectedIndicators[1] === type) { btn.classList.add('selected-y2'); tag.textContent = 'Y2'; }
        });
    }
    
    // =====================================================
    // EXPORT PDF
    // =====================================================
    function exportPDF() {
        showLoading('G√©n√©ration du PDF...');
        
        // Cr√©er un canvas temporaire pour le graphique en mode light
        createLightChartForPDF(function(chartImageBase64) {
            // Charger le logo en base64
            var logoImg = new Image();
            logoImg.crossOrigin = 'Anonymous';
            logoImg.onload = function() {
                var canvas = document.createElement('canvas');
                canvas.width = logoImg.width;
                canvas.height = logoImg.height;
                var ctx = canvas.getContext('2d');
                ctx.drawImage(logoImg, 0, 0);
                var logoBase64 = canvas.toDataURL('image/png');
                generatePDFWithLogo(logoBase64, chartImageBase64);
            };
            logoImg.onerror = function() {
                generatePDFWithLogo(null, chartImageBase64);
            };
            logoImg.src = 'Logo_Dataferme.png';
        });
    }
    
    function createLightChartForPDF(callback) {
        // Cr√©er un canvas temporaire hors √©cran
        var tempContainer = document.createElement('div');
        tempContainer.style.position = 'absolute';
        tempContainer.style.left = '-9999px';
        tempContainer.style.width = '1200px';
        tempContainer.style.height = '500px';
        document.body.appendChild(tempContainer);
        
        var tempCanvas = document.createElement('canvas');
        tempCanvas.width = 1200;
        tempCanvas.height = 500;
        tempContainer.appendChild(tempCanvas);
        
        var ctx = tempCanvas.getContext('2d');
        
        // Donn√©es du graphique
        var t1 = selectedIndicators[0];
        var t2 = selectedIndicators[1];
        var ind1 = INDICATORS[t1];
        var d1 = filterByPeriod(lotData[t1] || []);
        var std1 = standardsData[t1] || [];
        
        if (d1.length === 0) {
            document.body.removeChild(tempContainer);
            callback(null);
            return;
        }
        
        var labels = d1.map(function(d) { return 'J' + d.jour_age; });
        var jours = d1.map(function(d) { return d.jour_age; });
        
        var datasets = [];
        
        // Couleurs pour le th√®me light
        var lightColors = {
            grid: 'rgba(148, 163, 184, 0.3)',
            text: '#64748b',
            textDark: '#1e293b'
        };
        
        // Y1 Zone de tol√©rance
        var min1 = [], max1 = [];
        jours.forEach(function(j) {
            var s = std1.find(function(x) { return x.jour_age === j; });
            min1.push(s ? (parseFloat(s[ind1.stdMinField]) || null) : null);
            max1.push(s ? (parseFloat(s[ind1.stdMaxField]) || null) : null);
        });
        
        if (max1.some(function(v) { return v !== null; })) {
            datasets.push({ label: '_z1max', data: max1, borderColor: 'transparent', backgroundColor: ind1.colorArea, fill: '+1', pointRadius: 0, yAxisID: 'y1', order: 100 });
            datasets.push({ label: '_z1min', data: min1, borderColor: ind1.colorBorder, borderWidth: 1, borderDash: [5,5], backgroundColor: 'transparent', fill: false, pointRadius: 0, yAxisID: 'y1', order: 99 });
            datasets.push({ label: '_z1maxL', data: max1, borderColor: ind1.colorBorder, borderWidth: 1, borderDash: [5,5], backgroundColor: 'transparent', fill: false, pointRadius: 0, yAxisID: 'y1', order: 99 });
        }
        
        var v1 = d1.map(function(d) { return parseFloat(d[ind1.dataField]) || 0; });
        datasets.push({ 
            label: ind1.label, 
            data: v1, 
            borderColor: ind1.color, 
            backgroundColor: ind1.color, 
            borderWidth: 2, 
            tension: 0.35, 
            fill: false, 
            pointRadius: 2,
            pointBackgroundColor: ind1.color,
            yAxisID: 'y1', 
            order: 1 
        });
        
        var scales = {
            x: { 
                grid: { color: lightColors.grid }, 
                ticks: { color: lightColors.text, maxTicksLimit: 15 }, 
                title: { display: true, text: 'Jours du cycle', color: lightColors.textDark } 
            },
            y1: { 
                type: 'linear', 
                position: 'left', 
                grid: { color: lightColors.grid }, 
                ticks: { color: ind1.color }, 
                title: { display: true, text: ind1.label + ' (' + ind1.unit + ')', color: ind1.color } 
            }
        };
        
        if (t2) {
            var ind2 = INDICATORS[t2];
            var d2 = filterByPeriod(lotData[t2] || []);
            var std2 = standardsData[t2] || [];
            
            var min2 = [], max2 = [];
            jours.forEach(function(j) {
                var s = std2.find(function(x) { return x.jour_age === j; });
                min2.push(s ? (parseFloat(s[ind2.stdMinField]) || null) : null);
                max2.push(s ? (parseFloat(s[ind2.stdMaxField]) || null) : null);
            });
            
            if (max2.some(function(v) { return v !== null; })) {
                datasets.push({ label: '_z2max', data: max2, borderColor: 'transparent', backgroundColor: ind2.colorArea, fill: '+1', pointRadius: 0, yAxisID: 'y2', order: 98 });
                datasets.push({ label: '_z2min', data: min2, borderColor: ind2.colorBorder, borderWidth: 1, borderDash: [5,5], backgroundColor: 'transparent', fill: false, pointRadius: 0, yAxisID: 'y2', order: 97 });
                datasets.push({ label: '_z2maxL', data: max2, borderColor: ind2.colorBorder, borderWidth: 1, borderDash: [5,5], backgroundColor: 'transparent', fill: false, pointRadius: 0, yAxisID: 'y2', order: 97 });
            }
            
            var v2 = jours.map(function(j) {
                var d = d2.find(function(x) { return x.jour_age === j; });
                return d ? (parseFloat(d[ind2.dataField]) || 0) : null;
            });
            
            datasets.push({ 
                label: ind2.label, 
                data: v2, 
                borderColor: ind2.color, 
                backgroundColor: ind2.color, 
                borderWidth: 2, 
                tension: 0.35, 
                fill: false, 
                pointRadius: 2,
                pointBackgroundColor: ind2.color,
                yAxisID: 'y2', 
                order: 2 
            });
            
            scales.y2 = { 
                type: 'linear', 
                position: 'right', 
                grid: { drawOnChartArea: false }, 
                ticks: { color: ind2.color }, 
                title: { display: true, text: ind2.label + ' (' + ind2.unit + ')', color: ind2.color } 
            };
        }
        
        // Cr√©er le graphique temporaire avec fond blanc
        var tempChart = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: datasets },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                animation: false,
                plugins: { 
                    legend: { display: false }
                },
                scales: scales,
                layout: {
                    padding: 10
                }
            }
        });
        
        // Attendre que le graphique soit rendu
        setTimeout(function() {
            // Cr√©er un canvas avec fond blanc
            var finalCanvas = document.createElement('canvas');
            finalCanvas.width = 1200;
            finalCanvas.height = 500;
            var finalCtx = finalCanvas.getContext('2d');
            
            // Fond blanc
            finalCtx.fillStyle = '#ffffff';
            finalCtx.fillRect(0, 0, 1200, 500);
            
            // Dessiner le graphique par-dessus
            finalCtx.drawImage(tempCanvas, 0, 0);
            
            var imageBase64 = finalCanvas.toDataURL('image/png', 1.0);
            
            // Nettoyer
            tempChart.destroy();
            document.body.removeChild(tempContainer);
            
            callback(imageBase64);
        }, 100);
    }
    
    function generatePDFWithLogo(logoBase64, chartImageBase64) {
        setTimeout(function() {
            try {
                var jsPDF = window.jspdf.jsPDF;
                var doc = new jsPDF('landscape', 'mm', 'a4');
                var pageWidth = doc.internal.pageSize.getWidth();
                var pageHeight = doc.internal.pageSize.getHeight();
                var margin = 15;
                
                // Th√®me CLAIR pour le PDF
                var colors = {
                    bgPage: [255, 255, 255],        // Blanc
                    bgCard: [241, 245, 249],        // Gris tr√®s clair
                    bgCardAlt: [226, 232, 240],     // Gris clair
                    textDark: [30, 41, 59],         // Texte principal fonc√©
                    textMuted: [100, 116, 139],     // Texte secondaire
                    accent: [37, 99, 235],          // Bleu accent
                    success: [22, 163, 74],         // Vert
                    border: [203, 213, 225]         // Bordure
                };
                
                // Fond blanc
                doc.setFillColor(colors.bgPage[0], colors.bgPage[1], colors.bgPage[2]);
                doc.rect(0, 0, pageWidth, pageHeight, 'F');
                
                // Logo
                var titleStartX = margin;
                if (logoBase64) {
                    try {
                        doc.addImage(logoBase64, 'PNG', margin, 5, 50, 25);
                        titleStartX = margin + 55;
                    } catch(e) { console.log('Erreur logo PDF:', e); }
                }
                
                // Titre principal
                doc.setTextColor(colors.textDark[0], colors.textDark[1], colors.textDark[2]);
                doc.setFontSize(22);
                doc.text('Rapport de Suivi', titleStartX, 15);
                
                doc.setFontSize(12);
                doc.setTextColor(colors.textMuted[0], colors.textMuted[1], colors.textMuted[2]);
                var now = new Date();
                doc.text('G√©n√©r√© le ' + now.toLocaleDateString('fr-FR') + ' √† ' + now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}), titleStartX, 24);
                
                // Position des blocs d'info
                var infoY = 38;
                
                // Bloc √âleveur
                doc.setFillColor(colors.bgCard[0], colors.bgCard[1], colors.bgCard[2]);
                doc.setDrawColor(colors.border[0], colors.border[1], colors.border[2]);
                doc.roundedRect(margin, infoY, 80, 28, 3, 3, 'FD');
                doc.setTextColor(colors.textMuted[0], colors.textMuted[1], colors.textMuted[2]);
                doc.setFontSize(8);
                doc.text('INFORMATIONS √âLEVEUR', margin + 5, infoY + 7);
                doc.setTextColor(colors.textDark[0], colors.textDark[1], colors.textDark[2]);
                doc.setFontSize(11);
                var eleveurNom = currentEleveur ? (currentEleveur.nom + ' ' + (currentEleveur.prenom || '')) : '--';
                doc.text(eleveurNom, margin + 5, infoY + 15);
                doc.setFontSize(9);
                doc.setTextColor(colors.success[0], colors.success[1], colors.success[2]);
                var eleveurCode = currentEleveur ? ('Code: ' + currentEleveur.code_eleveur) : '';
                doc.text(eleveurCode, margin + 5, infoY + 22);
                
                // Bloc Lot
                doc.setFillColor(colors.bgCard[0], colors.bgCard[1], colors.bgCard[2]);
                doc.roundedRect(margin + 85, infoY, 80, 28, 3, 3, 'FD');
                doc.setTextColor(colors.textMuted[0], colors.textMuted[1], colors.textMuted[2]);
                doc.setFontSize(8);
                doc.text('INFORMATIONS DU LOT', margin + 90, infoY + 7);
                doc.setTextColor(colors.textDark[0], colors.textDark[1], colors.textDark[2]);
                doc.setFontSize(11);
                var lotInfo = currentLotInfo ? (currentLotInfo.code_lot + ' - ' + (currentBatiment ? currentBatiment.nom : '')) : '--';
                doc.text(lotInfo, margin + 90, infoY + 15);
                doc.setFontSize(9);
                doc.setTextColor(colors.textMuted[0], colors.textMuted[1], colors.textMuted[2]);
                var soucheNamePDF = currentLotInfo && currentLotInfo.souche_nom ? currentLotInfo.souche_nom : '--';
                var lotDetails = 'Effectif: ' + (currentLotInfo && currentLotInfo.effectif_depart ? currentLotInfo.effectif_depart.toLocaleString('fr-FR') : '--');
                lotDetails += ' | Souche: ' + soucheNamePDF;
                doc.text(lotDetails, margin + 90, infoY + 22);
                
                // Bloc Indicateurs
                doc.setFillColor(colors.bgCard[0], colors.bgCard[1], colors.bgCard[2]);
                doc.roundedRect(margin + 170, infoY, 55, 28, 3, 3, 'FD');
                doc.setTextColor(colors.textMuted[0], colors.textMuted[1], colors.textMuted[2]);
                doc.setFontSize(8);
                doc.text('INDICATEURS', margin + 175, infoY + 7);
                doc.setTextColor(colors.accent[0], colors.accent[1], colors.accent[2]);
                doc.setFontSize(10);
                var indicateursText = selectedIndicators.map(function(t) { return INDICATORS[t].label; }).join(', ');
                if (indicateursText.length > 25) indicateursText = indicateursText.substring(0, 22) + '...';
                doc.text(indicateursText, margin + 175, infoY + 15);
                doc.setFontSize(9);
                doc.setTextColor(colors.textMuted[0], colors.textMuted[1], colors.textMuted[2]);
                var periodeText = 'P√©riode: ' + (currentPeriod === 'all' ? 'Tout' : currentPeriod + ' jours');
                doc.text(periodeText, margin + 175, infoY + 22);
                
                // Bloc Valeur actuelle
                var t1 = selectedIndicators[0];
                var ind1 = INDICATORS[t1];
                var d1 = lotData[t1] || [];
                var lastVal = d1.length > 0 ? Math.round(parseFloat(d1[d1.length - 1][ind1.dataField]) || 0) : '--';
                
                doc.setFillColor(colors.bgCardAlt[0], colors.bgCardAlt[1], colors.bgCardAlt[2]);
                doc.roundedRect(margin + 230, infoY, 47, 28, 3, 3, 'FD');
                doc.setTextColor(colors.textMuted[0], colors.textMuted[1], colors.textMuted[2]);
                doc.setFontSize(8);
                doc.text('VALEUR ACTUELLE', margin + 235, infoY + 7);
                doc.setTextColor(colors.accent[0], colors.accent[1], colors.accent[2]);
                doc.setFontSize(18);
                doc.text(lastVal + ' ' + ind1.unit, margin + 235, infoY + 20);
                
                // Zone du graphique
                var chartY = infoY + 33;
                
                // Utiliser le graphique light g√©n√©r√©
                if (chartImageBase64) {
                    doc.setFillColor(colors.bgCard[0], colors.bgCard[1], colors.bgCard[2]);
                    doc.roundedRect(margin, chartY, pageWidth - 2*margin, pageHeight - chartY - 15, 3, 3, 'FD');
                    doc.setTextColor(colors.textDark[0], colors.textDark[1], colors.textDark[2]);
                    doc.setFontSize(14);
                    doc.text($('chartTitle').textContent, margin + 10, chartY + 12);
                    doc.addImage(chartImageBase64, 'PNG', margin + 5, chartY + 18, pageWidth - 2*margin - 10, pageHeight - chartY - 38);
                }
                
                // Footer
                doc.setTextColor(colors.textMuted[0], colors.textMuted[1], colors.textMuted[2]);
                doc.setFontSize(8);
                doc.text('Dataferme v15.6 - ADOSI', margin, pageHeight - 5);
                doc.text('Page 1/1', pageWidth - margin - 15, pageHeight - 5);
                
                var filename = 'Dataferme_Rapport_' + (currentLotInfo ? currentLotInfo.code_lot : 'export') + '_' + now.toISOString().slice(0,10) + '.pdf';
                doc.save(filename);
                hideLoading();
            } catch (e) {
                console.error('Erreur PDF:', e);
                hideLoading();
                alert('Erreur lors de la g√©n√©ration du PDF: ' + e.message);
            }
        }, 100);
    }
    
    // =====================================================
    // EXPORT EXCEL
    // =====================================================
    function exportExcel() {
        showLoading('G√©n√©ration du fichier Excel...');
        setTimeout(function() {
            try {
                var wb = XLSX.utils.book_new();
                var soucheNameExcel = currentLotInfo && currentLotInfo.souche_nom ? currentLotInfo.souche_nom : '--';
                
                var infoData = [
                    ['Dataferme - Rapport de Suivi Production Avicole'],
                    [''],
                    ['G√©n√©r√© le', new Date().toLocaleDateString('fr-FR') + ' ' + new Date().toLocaleTimeString('fr-FR')],
                    [''],
                    ['INFORMATIONS √âLEVEUR'],
                    ['Nom', currentEleveur ? (currentEleveur.nom + ' ' + (currentEleveur.prenom || '')) : '--'],
                    ['Code', currentEleveur ? currentEleveur.code_eleveur : '--'],
                    ['Raison sociale', currentEleveur ? (currentEleveur.raison_sociale || '--') : '--'],
                    [''],
                    ['INFORMATIONS LOT'],
                    ['Code lot', currentLotInfo ? currentLotInfo.code_lot : '--'],
                    ['B√¢timent', currentBatiment ? currentBatiment.nom : '--'],
                    ['Site', currentSite ? currentSite.nom : '--'],
                    ['Effectif d√©part', currentLotInfo ? currentLotInfo.effectif_depart : '--'],
                    ['Souche', soucheNameExcel],
                    ['Date mise en place', currentLotInfo ? currentLotInfo.date_mise_place : '--'],
                    ['Statut', currentLotInfo ? currentLotInfo.statut : '--']
                ];
                var wsInfo = XLSX.utils.aoa_to_sheet(infoData);
                XLSX.utils.book_append_sheet(wb, wsInfo, 'Informations');
                
                selectedIndicators.forEach(function(type) {
                    var ind = INDICATORS[type];
                    var data = filterByPeriod(lotData[type] || []);
                    var std = standardsData[type] || [];
                    
                    if (data.length > 0) {
                        var sheetData = [
                            [ind.label + ' (' + ind.unit + ')'],
                            [''],
                            ['Jour', 'Valeur', 'Standard Min', 'Standard Max', '√âcart vs Cible']
                        ];
                        
                        data.forEach(function(d) {
                            var jour = d.jour_age;
                            var val = parseFloat(d[ind.dataField]) || 0;
                            var stdRow = std.find(function(s) { return s.jour_age === jour; });
                            var stdMin = stdRow ? (parseFloat(stdRow[ind.stdMinField]) || '') : '';
                            var stdMax = stdRow ? (parseFloat(stdRow[ind.stdMaxField]) || '') : '';
                            var cible = stdRow ? ((parseFloat(stdRow[ind.stdMinField]) + parseFloat(stdRow[ind.stdMaxField])) / 2) : null;
                            var ecart = cible ? (((val - cible) / cible) * 100).toFixed(1) + '%' : '';
                            sheetData.push([jour, val, stdMin, stdMax, ecart]);
                        });
                        
                        var ws = XLSX.utils.aoa_to_sheet(sheetData);
                        XLSX.utils.book_append_sheet(wb, ws, ind.label.substring(0, 31));
                    }
                });
                
                var filename = 'Dataferme_Donnees_' + (currentLotInfo ? currentLotInfo.code_lot : 'export') + '_' + new Date().toISOString().slice(0,10) + '.xlsx';
                XLSX.writeFile(wb, filename);
                hideLoading();
            } catch (e) {
                console.error('Erreur Excel:', e);
                hideLoading();
                alert('Erreur lors de la g√©n√©ration Excel: ' + e.message);
            }
        }, 100);
    }
    
    // =====================================================
    // THEME MANAGEMENT
    // =====================================================
    function getCurrentTheme() {
        return localStorage.getItem('dataferme-theme') || 'dark';
    }
    
    function setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('dataferme-theme', theme);
        
        // Update toggle buttons icons
        var icon = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        var toggleBtn = $('themeToggle');
        var toggleBtnLogin = $('themeToggleLogin');
        if (toggleBtn) toggleBtn.textContent = icon;
        if (toggleBtnLogin) toggleBtnLogin.textContent = icon;
        
        // Update chart if exists
        if (mainChart) {
            updateChartTheme();
        }
    }
    
    function toggleTheme() {
        var currentTheme = getCurrentTheme();
        var newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        setTheme(newTheme);
    }
    
    function updateChartTheme() {
        // Redraw chart with new theme colors
        if (mainChart && currentLotInfo) {
            updateChart();
        }
    }
    
    function initTheme() {
        var savedTheme = getCurrentTheme();
        setTheme(savedTheme);
    }
    
    // =====================================================
    // INIT
    // =====================================================
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize theme first
        initTheme();
        
        loadConfig();
        
        // Theme toggles
        $('themeToggle').addEventListener('click', toggleTheme);
        $('themeToggleLogin').addEventListener('click', toggleTheme);
        
        // Login
        $('loginBtn').addEventListener('click', doLogin);
        $('loginPass').addEventListener('keypress', function(e) { if (e.key === 'Enter') doLogin(); });
        $('btnLogout').addEventListener('click', doLogout);
        
        // Admin menu
        document.querySelectorAll('.admin-menu-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                switchAdminPanel(this.getAttribute('data-panel'));
            });
        });
        
        // API Config
        $('btnSaveApiConfig').addEventListener('click', saveApiConfig);
        $('btnShowApiKey').addEventListener('click', toggleApiKeyVisibility);
        
        // Users
        $('btnNewUser').addEventListener('click', function() { openUserModal(null); });
        $('closeUserModal').addEventListener('click', closeUserModal);
        $('cancelUserModal').addEventListener('click', closeUserModal);
        $('saveUserModal').addEventListener('click', saveUser);
        
        // Data selectors
        $('selEleveur').addEventListener('change', onEleveurChange);
        $('selSite').addEventListener('change', onSiteChange);
        $('selBatiment').addEventListener('change', onBatimentChange);
        $('selLot').addEventListener('change', onLotChange);
        
        // Indicators
        document.querySelectorAll('#indicatorBtns .indicator-btn').forEach(function(btn) { btn.addEventListener('click', onIndicatorClick); });
        document.querySelectorAll('#periodBtns .period-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#periodBtns .period-btn').forEach(function(b) { b.classList.remove('active'); });
                this.classList.add('active');
                currentPeriod = this.getAttribute('data-period');
                updateUI();
            });
        });
        
        // Exports
        $('btnExportPDF').addEventListener('click', exportPDF);
        $('btnExportExcel').addEventListener('click', exportExcel);
    });
})();
</script>
</body>
</html>
